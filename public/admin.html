<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araquari Cestas - Painel Admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#14141f;--border:#1e1e30;--orange:#E8850C;--green:#3DA33D;--red:#e74c3c;--yellow:#f39c12;--blue:#3498db;--text:#fff;--text2:#a0a0b0;--text3:#606070}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.topbar{background:var(--card);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar h1{font-size:16px;font-weight:800;color:var(--orange)}
.topbar .subtitle{font-size:11px;color:var(--text3);margin-top:2px}
.container{max-width:1200px;margin:0 auto;padding:20px}

/* Login */
.login-box{max-width:360px;margin:80px auto;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px 32px;text-align:center}
.login-box h2{font-size:20px;margin-bottom:8px}
.login-box p{font-size:13px;color:var(--text3);margin-bottom:24px}
.login-box input{width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;margin-bottom:16px;text-align:center;letter-spacing:1px}
.login-box input:focus{outline:none;border-color:var(--orange)}

/* KPI Cards */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 20px}
.kpi-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.kpi-value{font-size:28px;font-weight:900;margin-top:4px}
.kpi-sub{font-size:12px;color:var(--text2);margin-top:4px}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.tab{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;background:var(--card);border:1px solid var(--border);color:var(--text2);transition:.2s}
.tab.active,.tab:hover{background:var(--orange);color:#fff;border-color:var(--orange)}

/* Filters */
.filters{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.filters select,.filters input{padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px}
.filters select:focus,.filters input:focus{outline:none;border-color:var(--orange)}

/* Table */
.table-wrap{overflow-x:auto;background:var(--card);border:1px solid var(--border);border-radius:14px}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:12px 14px;color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:10px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover{background:#ffffff05}

/* Status badges */
.badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;display:inline-block}
.badge-novo{background:#3498db20;color:#3498db}
.badge-confirmado{background:#3DA33D20;color:#3DA33D}
.badge-separacao{background:#E8850C20;color:#E8850C}
.badge-pronto{background:#2ecc7120;color:#2ecc71}
.badge-a_caminho{background:#9b59b620;color:#9b59b6}
.badge-entregue{background:#3DA33D20;color:#3DA33D}
.badge-cancelado{background:#e74c3c20;color:#e74c3c}
.badge-analise{background:#f39c1220;color:#f39c12}
.badge-aprovado{background:#3DA33D20;color:#3DA33D}
.badge-recusado{background:#e74c3c20;color:#e74c3c}

/* Buttons */
.btn{padding:8px 16px;border:none;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;transition:.2s}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-orange{background:var(--orange);color:#fff}
.btn-green{background:var(--green);color:#fff}
.btn-red{background:var(--red);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn:hover{opacity:.85;transform:scale(1.02)}

/* Modal */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
.modal h3{font-size:18px;margin-bottom:16px}
.modal-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.modal-row:last-child{border:none}
.modal-row .label{color:var(--text3)}
.modal-row .value{font-weight:700;text-align:right}
.modal-actions{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}

/* Status select in modal */
.status-select{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;margin:12px 0}
.obs-input{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;margin-bottom:12px;resize:vertical;min-height:60px}

/* Doc links */
.doc-link{color:var(--blue);text-decoration:none;font-weight:600}
.doc-link:hover{text-decoration:underline}

/* Responsive */
@media(max-width:600px){
    .container{padding:12px}
    .kpi-value{font-size:22px}
    .filters{flex-direction:column}
    .filters select,.filters input{width:100%}
}

/* Loading */
.loading{text-align:center;padding:40px;color:var(--text3)}
.spin{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--orange);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* History */
.hist-item{display:flex;gap:12px;padding:8px 0;font-size:12px;border-bottom:1px solid var(--border)}
.hist-item:last-child{border:none}
.hist-dot{width:8px;height:8px;border-radius:50%;background:var(--orange);margin-top:4px;flex-shrink:0}

/* Notification Toast */
.toast-container{position:fixed;top:60px;right:16px;z-index:300;display:flex;flex-direction:column;gap:10px;max-width:380px;width:calc(100% - 32px)}
.toast{background:#1a2e1a;border:2px solid var(--green);border-radius:14px;padding:16px;animation:toastIn .4s ease;box-shadow:0 8px 32px rgba(0,0,0,.5);cursor:pointer;transition:opacity .3s}
.toast.hide{opacity:0;transform:translateX(100%)}
@keyframes toastIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.toast-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.toast-badge{background:var(--green);color:#fff;font-size:10px;font-weight:800;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:0.5px}
.toast-close{margin-left:auto;background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;padding:0 4px}
.toast-title{font-size:15px;font-weight:800;color:var(--green);margin-bottom:4px}
.toast-body{font-size:12px;color:var(--text2);line-height:1.5}
.toast-body strong{color:var(--text);font-weight:700}
.toast-accept{margin-top:10px;width:100%;padding:10px;background:var(--green);color:#fff;border:none;border-radius:8px;font-weight:800;font-size:13px;cursor:pointer}
.toast-accept:hover{opacity:.9}
.toast-actions{display:flex;gap:6px;margin-top:10px}
.toast-actions button{flex:1;padding:9px 6px;border:none;border-radius:8px;font-weight:800;font-size:11px;cursor:pointer;color:#fff;transition:.2s}
.toast-actions button:hover{opacity:.85}
.toast-clear-all{background:var(--border);color:var(--text2);border:none;padding:8px 16px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;margin-bottom:8px;display:none}
.toast-clear-all:hover{background:var(--text3);color:#fff}

/* Sound enable banner */
.sound-banner{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--orange);color:#fff;padding:12px 24px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;z-index:250;box-shadow:0 4px 20px rgba(232,133,12,.4);animation:pulse 2s infinite;display:none;text-align:center;white-space:nowrap}
@keyframes pulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.03)}}

/* Alert flash on topbar */
.topbar.alert-flash{animation:alertFlash 1s ease 3}
@keyframes alertFlash{0%,100%{border-bottom-color:var(--border)}50%{border-bottom-color:var(--green)}}
/* ‚ïê‚ïê‚ïê TOAST & CONFIRM MODAL ‚ïê‚ïê‚ïê */
.app-toast{position:fixed;top:0;left:50%;transform:translateX(-50%) translateY(-100%);z-index:99999;padding:14px 20px;border-radius:0 0 16px 16px;font-size:13px;font-weight:700;max-width:500px;width:100%;text-align:center;transition:transform .35s cubic-bezier(.22,1,.36,1);line-height:1.5;box-shadow:0 8px 30px rgba(0,0,0,.4)}
.app-toast.show{transform:translateX(-50%) translateY(0)}
.app-toast.success{background:linear-gradient(135deg,#1a3a1a,#0d2e0d);color:#34c759;border-bottom:2px solid #34c759}
.app-toast.error{background:linear-gradient(135deg,#3a1a1a,#2e0d0d);color:#ff453a;border-bottom:2px solid #ff453a}
.app-toast.warning{background:linear-gradient(135deg,#3a2e1a,#2e200d);color:#E8850C;border-bottom:2px solid #E8850C}
.app-toast.info{background:linear-gradient(135deg,#1a2a3a,#0d1e2e);color:#64d2ff;border-bottom:2px solid #64d2ff}
.confirm-overlay{position:fixed;inset:0;z-index:99998;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s}
.confirm-overlay.show{opacity:1;pointer-events:auto}
.confirm-box{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:28px 24px 20px;max-width:380px;width:90%;text-align:center;transform:scale(.9);transition:transform .25s}
.confirm-overlay.show .confirm-box{transform:scale(1)}
.confirm-icon{font-size:36px;margin-bottom:10px}
.confirm-title{font-size:15px;font-weight:800;color:var(--text);margin-bottom:6px}
.confirm-msg{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:18px}
.confirm-btns{display:flex;gap:10px}
.confirm-btns .cbtn{flex:1;padding:12px;font-size:13px;font-weight:800;border-radius:12px;border:none;cursor:pointer}
.cbtn-cancel{background:var(--border);color:var(--text)}
.cbtn-ok{background:var(--orange);color:#fff}
.cbtn-danger{background:#ff453a;color:#fff}
</style>
</head>
<body>

<div class="topbar">
    <div>
        <h1>Araquari Cestas - Admin</h1>
        <div class="subtitle" id="admin-subtitle">Painel de Gerenciamento</div>
    </div>
    <div id="logout-area" style="display:none">
        <button class="btn btn-sm btn-orange" onclick="logout()">Sair</button>
    </div>
</div>

<!-- Login -->
<div id="login-screen">
    <div class="login-box">
        <h2>Painel Admin</h2>
        <p>Digite o token de acesso</p>
        <input type="password" id="token-input" placeholder="Token de admin" onkeydown="if(event.key==='Enter')doLogin()">
        <button class="btn btn-orange" onclick="doLogin()" style="width:100%;padding:12px">Entrar</button>
        <div id="login-error" style="color:var(--red);font-size:12px;margin-top:12px;display:none">Token invalido</div>
    </div>
</div>

<!-- Dashboard -->
<div id="admin-panel" style="display:none">
<div class="container">

    <!-- KPIs -->
    <div class="kpi-grid" id="kpi-grid">
        <div class="kpi"><div class="kpi-label">Pedidos Hoje (pagos)</div><div class="kpi-value" id="kpi-hoje">-</div></div>
        <div class="kpi"><div class="kpi-label">Receita Hoje (confirmada)</div><div class="kpi-value" id="kpi-receita-hoje" style="color:var(--green)">-</div></div>
        <div class="kpi"><div class="kpi-label">Receita Pendente</div><div class="kpi-value" id="kpi-receita-pendente" style="color:var(--orange)">-</div></div>
        <div class="kpi"><div class="kpi-label">Total Pedidos</div><div class="kpi-value" id="kpi-total">-</div></div>
        <div class="kpi"><div class="kpi-label">Pendentes Analise</div><div class="kpi-value" id="kpi-analise" style="color:var(--yellow)">-</div></div>
        <div class="kpi"><div class="kpi-label">Aguardando Pagamento</div><div class="kpi-value" id="kpi-nao-pagos" style="color:var(--blue)">-</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="pedidos" onclick="switchTab('pedidos')">Pedidos</div>
        <div class="tab" data-tab="analise" onclick="switchTab('analise')">Boleto 30d</div>
        <div class="tab" data-tab="naopagos" onclick="switchTab('naopagos')" style="border-color:var(--blue)">Aguardando Pagamento</div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <select id="filter-status" onchange="loadPedidos()">
            <option value="">Todos os status</option>
            <option value="novo">Novo</option>
            <option value="confirmado">Confirmado</option>
            <option value="separacao">Em Separacao</option>
            <option value="pronto">Pronto</option>
            <option value="a_caminho">A Caminho</option>
            <option value="entregue">Entregue</option>
            <option value="cancelado">Cancelado</option>
            <option value="analise">Em Analise</option>
            <option value="aprovado">Aprovado</option>
            <option value="recusado">Recusado</option>
        </select>
        <select id="filter-cesta" onchange="loadPedidos()">
            <option value="">Todas as cestas</option>
            <option value="x">Cesta X</option>
            <option value="confort">Cesta Confort</option>
            <option value="plus">Cesta Plus</option>
        </select>
        <input type="text" id="filter-busca" placeholder="Buscar codigo, nome, tel..." onkeydown="if(event.key==='Enter')loadPedidos()">
        <button class="btn btn-sm btn-orange" onclick="loadPedidos()">Buscar</button>
        <button class="btn btn-sm btn-blue" onclick="loadDashboard();loadPedidos()">Atualizar</button>
    </div>

    <!-- Orders Table -->
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Codigo</th>
                    <th>Cesta</th>
                    <th>Recebedor</th>
                    <th>Telefone</th>
                    <th>Pagamento</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th>Acao</th>
                </tr>
            </thead>
            <tbody id="orders-tbody">
                <tr><td colspan="9" class="loading"><div class="spin"></div></td></tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" style="display:flex;justify-content:center;gap:8px;margin-top:16px"></div>

</div>
</div>

<!-- Order Detail Modal -->
<div class="modal-overlay" id="modal-detail">
    <div class="modal" id="modal-content"></div>
</div>

<!-- Notification Toasts -->
<div class="toast-container" id="toast-container">
    <button class="toast-clear-all" id="toast-clear-all" onclick="clearAllToasts()">Limpar todas as notificacoes</button>
</div>

<!-- Sound Enable Banner -->
<div class="sound-banner" id="sound-banner" onclick="enableSound()">
    üîî Toque aqui para ativar alertas sonoros
</div>

<!-- App Toast -->
<div class="app-toast" id="app-toast"></div>
<!-- Confirm Modal -->
<div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-box">
        <div class="confirm-icon" id="confirm-icon"></div>
        <div class="confirm-title" id="confirm-title"></div>
        <div class="confirm-msg" id="confirm-msg"></div>
        <div class="confirm-btns">
            <button class="cbtn cbtn-cancel" id="confirm-cancel">Cancelar</button>
            <button class="cbtn cbtn-ok" id="confirm-ok">Confirmar</button>
        </div>
    </div>
</div>

<script>
let _toastTimer = null;
function showToast(msg, type='info', dur=3500) {
    const t = document.getElementById('app-toast');
    t.className = 'app-toast ' + type;
    const icons = {success:'\u2705',error:'\u274C',warning:'\u26A0\uFE0F',info:'\u2139\uFE0F'};
    t.innerHTML = (icons[type]||'') + ' ' + msg;
    clearTimeout(_toastTimer);
    requestAnimationFrame(() => t.classList.add('show'));
    _toastTimer = setTimeout(() => t.classList.remove('show'), dur);
}
function showConfirm(title, msg, onOk, opts={}) {
    const ov = document.getElementById('confirm-overlay');
    document.getElementById('confirm-icon').textContent = opts.icon || '\u26A0\uFE0F';
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-msg').textContent = msg;
    const okBtn = document.getElementById('confirm-ok');
    const cancelBtn = document.getElementById('confirm-cancel');
    okBtn.textContent = opts.okText || 'Confirmar';
    okBtn.className = 'cbtn ' + (opts.danger ? 'cbtn-danger' : 'cbtn-ok');
    cancelBtn.textContent = opts.cancelText || 'Cancelar';
    ov.classList.add('show');
    const close = () => { ov.classList.remove('show'); okBtn.onclick = null; cancelBtn.onclick = null; };
    okBtn.onclick = () => { close(); if(onOk) onOk(); };
    cancelBtn.onclick = close;
}
let TOKEN = localStorage.getItem('admin_token') || '';
let currentPage = 1;
let currentTab = 'pedidos';
const API = '/api/admin';
const STATUS_LABELS = {
    'novo':'Novo','confirmado':'Confirmado','separacao':'Em Separacao',
    'pronto':'Pronto','a_caminho':'A Caminho','entregue':'Entregue',
    'cancelado':'Cancelado','analise':'Em Analise','aprovado':'Aprovado','recusado':'Recusado'
};
const PAY_LABELS = {'pix':'PIX','cartao':'Cartao','boleto':'Boleto','boleto30':'Boleto 30d'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW ORDER NOTIFICATION SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let knownOrderCodes = new Set();
let knownOrderStatuses = {};
let isFirstLoad = true;
let soundEnabled = false;
let audioCtx = null;

// Auto-enable sound on ANY user interaction (click, scroll, keypress, touch)
function autoEnableSound() {
    if(soundEnabled) return;
    enableSound();
    // Also request push notification permission
    if('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}
['click','touchstart','keydown','scroll'].forEach(evt => {
    document.addEventListener(evt, autoEnableSound, {once: false, passive: true});
});

// Also try on load (won't work without interaction, but worth trying)
window.addEventListener('load', () => {
    // Try to enable immediately (works if user already interacted)
    try {
        enableSound();
    } catch(e) {}
    // Show subtle reminder if still not enabled after 3s
    setTimeout(() => {
        if(!soundEnabled) {
            const banner = document.getElementById('sound-banner');
            banner.style.display = 'block';
            banner.textContent = '\uD83D\uDD14 Toque em qualquer lugar para ativar alertas sonoros';
        }
    }, 3000);
});

function enableSound() {
    try {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        // Play a silent sound to unlock audio
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        gain.gain.value = 0.01;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        soundEnabled = true;
        document.getElementById('sound-banner').style.display = 'none';
        // Remove listeners once enabled
        ['click','touchstart','keydown','scroll'].forEach(evt => {
            document.removeEventListener(evt, autoEnableSound);
        });
    } catch(e) { console.warn('Audio not available:', e); }
}

let alarmInterval = null;
let titleInterval = null;

function playAlertSound() {
    if(!soundEnabled || !audioCtx) return;
    // Stop any existing alarm first
    stopAlarm();
    // Start persistent alarm - plays every 1.5s until stopped
    playAlarmChime();
    alarmInterval = setInterval(playAlarmChime, 1500);
    // Flash page title continuously
    let flip = false;
    titleInterval = setInterval(() => {
        flip = !flip;
        document.title = flip ? 'NOVO PEDIDO!' : 'Araquari Cestas - Admin';
    }, 800);
}

function playAlarmChime() {
    if(!soundEnabled || !audioCtx) return;
    try {
        const now = audioCtx.currentTime;
        // Urgent ascending 3-tone chime
        [0, 0.12, 0.24].forEach((delay, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.value = 700 + (i * 250);
            gain.gain.setValueAtTime(0.35, now + delay);
            gain.gain.exponentialRampToValueAtTime(0.01, now + delay + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now + delay);
            osc.stop(now + delay + 0.12);
        });
        // Final high sustained tone for urgency
        const osc2 = audioCtx.createOscillator();
        const gain2 = audioCtx.createGain();
        osc2.type = 'sine';
        osc2.frequency.value = 1200;
        gain2.gain.setValueAtTime(0.3, now + 0.4);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.9);
        osc2.connect(gain2);
        gain2.connect(audioCtx.destination);
        osc2.start(now + 0.4);
        osc2.stop(now + 1.0);
    } catch(e) {}
}

function stopAlarm() {
    if(alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
    if(titleInterval) { clearInterval(titleInterval); titleInterval = null; }
    document.title = 'Araquari Cestas - Painel Admin';
}

function detectNewOrders(pedidos) {
    if(isFirstLoad) {
        // First load: store all codes and statuses, no alerts
        pedidos.forEach(p => {
            knownOrderCodes.add(p.codigo);
            knownOrderStatuses[p.codigo] = p.status;
        });
        isFirstLoad = false;
        return;
    }

    const alertOrders = [];

    pedidos.forEach(p => {
        const prevStatus = knownOrderStatuses[p.codigo];

        // Alert case 1: Brand new order that already has payment confirmed (not "novo")
        if(!knownOrderCodes.has(p.codigo) && p.status !== 'novo') {
            alertOrders.push(p);
        }
        // Alert case 2: Known order that just changed from "novo" to confirmed/paid status
        else if(prevStatus === 'novo' && p.status !== 'novo') {
            alertOrders.push(p);
        }

        // Update tracking
        knownOrderCodes.add(p.codigo);
        knownOrderStatuses[p.codigo] = p.status;
    });

    if(alertOrders.length > 0) {
        // Play persistent alarm
        playAlertSound();

        // Vibrate on mobile
        if(navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 300]);

        // Flash topbar
        document.querySelector('.topbar').classList.add('alert-flash');
        setTimeout(() => document.querySelector('.topbar').classList.remove('alert-flash'), 3000);

        // Browser push notification (works even with tab in background)
        if(Notification.permission === 'granted') {
            alertOrders.forEach(p => {
                try {
                    new Notification('\uD83D\uDCE6 Novo Pedido Confirmado!', {
                        body: `${p.codigo} - ${p.cesta_nome} - R$ ${parseFloat(p.total).toFixed(2).replace('.',',')}`,
                        icon: '/assets/img/logo.png',
                        tag: 'order-' + p.codigo,
                        requireInteraction: true
                    });
                } catch(e) {}
            });
        }

        // Show toast for each confirmed order
        alertOrders.forEach(p => showOrderToast(p));

        // Update page title
        document.title = `NOVO(S) PEDIDO(S)!`;
    }
}

function showOrderToast(p) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    const endereco = [p.endereco_rua, p.endereco_numero, p.endereco_bairro].filter(Boolean).join(', ');
    toast.innerHTML = `
        <div class="toast-header">
            <span class="toast-badge">Novo Pedido</span>
            <button class="toast-close" onclick="dismissToast(this)">X</button>
        </div>
        <div class="toast-title">${p.codigo} - ${p.cesta_nome}</div>
        <div class="toast-body">
            <strong>${p.recebedor_nome}</strong><br>
            ${endereco || 'Endereco nao informado'}<br>
            Tel: ${p.recebedor_telefone || '-'}<br>
            R$ ${parseFloat(p.total).toFixed(2).replace('.',',')} - ${PAY_LABELS[p.pagamento_metodo] || p.pagamento_metodo}
        </div>
        <button class="toast-accept" onclick="quickAccept(${p.id}, this)">Aceitar Pedido</button>
    `;
    container.prepend(toast);
    // Toast persists until accepted or manually dismissed - no auto-remove
}

function dismissToast(btn) {
    const toast = btn.closest('.toast');
    if(toast) { toast.classList.add('hide'); setTimeout(() => toast.remove(), 400); }
    // If no more toasts, stop alarm
    setTimeout(() => {
        const remaining = document.querySelectorAll('.toast:not(.hide)');
        if(remaining.length === 0) stopAlarm();
    }, 500);
}

async function quickAccept(pedidoId, btn) {
    btn.disabled = true;
    btn.textContent = 'Confirmando...';
    try {
        const res = await fetch(API+'/pedidos/'+pedidoId+'/status', {
            method: 'PATCH',
            headers: {'Content-Type':'application/json','x-admin-token':TOKEN},
            body: JSON.stringify({status:'confirmado', observacao:'Aceito via painel'})
        });
        const data = await res.json();
        if(data.success) {
            btn.textContent = 'Confirmado!';
            btn.style.background = 'var(--text3)';
            stopAlarm();
            loadDashboard();
            loadPedidos();
            setTimeout(() => btn.closest('.toast').remove(), 1500);
        } else {
            btn.textContent = 'Erro - tente no painel';
            btn.disabled = false;
        }
    } catch(e) {
        btn.textContent = 'Erro - tente no painel';
        btn.disabled = false;
    }
}

// Auth
function doLogin() {
    TOKEN = document.getElementById('token-input').value.trim();
    if(!TOKEN) return;
    fetch(API+'/dashboard', {headers:{'x-admin-token':TOKEN}})
        .then(r => {
            if(!r.ok) throw new Error();
            return r.json();
        })
        .then(data => {
            localStorage.setItem('admin_token', TOKEN);
            showPanel();
            renderDashboard(data);
            loadPedidos();
        })
        .catch(() => {
            document.getElementById('login-error').style.display = 'block';
        });
}

function logout() {
    TOKEN = '';
    localStorage.removeItem('admin_token');
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('login-screen').style.display = 'block';
    document.getElementById('logout-area').style.display = 'none';
}

function showPanel() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';
    document.getElementById('logout-area').style.display = 'block';
}

// Auto-login if token stored
if(TOKEN) {
    fetch(API+'/dashboard', {headers:{'x-admin-token':TOKEN}})
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => { showPanel(); renderDashboard(data); loadPedidos(); })
        .catch(() => logout());
}

// Dashboard
async function loadDashboard() {
    try {
        const res = await fetch(API+'/dashboard', {headers:{'x-admin-token':TOKEN}});
        const data = await res.json();
        renderDashboard(data);
    } catch(e) {}
}

function renderDashboard(d) {
    document.getElementById('kpi-hoje').textContent = d.pedidos_hoje;
    document.getElementById('kpi-receita-hoje').textContent = 'R$ '+d.receita_hoje.toFixed(2).replace('.',',');
    document.getElementById('kpi-receita-pendente').textContent = 'R$ '+(d.receita_pendente || 0).toFixed(2).replace('.',',');
    document.getElementById('kpi-total').textContent = d.total_pedidos;
    document.getElementById('kpi-analise').textContent = d.pendentes_analise;
    document.getElementById('kpi-nao-pagos').textContent = d.nao_pagos || 0;
}

// Tabs
function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
    if(tab === 'analise') {
        document.getElementById('filter-status').value = 'analise';
    } else if(tab === 'naopagos') {
        document.getElementById('filter-status').value = 'novo';
    } else {
        document.getElementById('filter-status').value = '';
    }
    currentPage = 1;
    loadPedidos();
}

// Load orders
async function loadPedidos() {
    const tbody = document.getElementById('orders-tbody');
    tbody.innerHTML = '<tr><td colspan="9" class="loading"><div class="spin"></div></td></tr>';

    const status = document.getElementById('filter-status').value;
    const cesta = document.getElementById('filter-cesta').value;
    const busca = document.getElementById('filter-busca').value;

    const params = new URLSearchParams();
    if(status) params.set('status', status);
    if(!status && currentTab === 'pedidos') params.set('excluir_status', 'novo,analise');
    if(cesta) params.set('cesta', cesta);
    if(busca) params.set('busca', busca);
    params.set('pagina', currentPage);
    params.set('limite', 25);

    try {
        const res = await fetch(API+'/pedidos?'+params, {headers:{'x-admin-token':TOKEN}});
        const data = await res.json();

        // Detect new orders and alert
        detectNewOrders(data.pedidos || []);

        if(data.pedidos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--text3)">Nenhum pedido encontrado</td></tr>';
            return;
        }

        tbody.innerHTML = data.pedidos.map(p => `
            <tr>
                <td style="font-weight:800;color:var(--orange)">${p.codigo}</td>
                <td>${p.cesta_nome}</td>
                <td style="font-weight:600">${p.recebedor_nome}</td>
                <td style="color:var(--text2)">${p.recebedor_telefone}</td>
                <td>${PAY_LABELS[p.pagamento_metodo]||p.pagamento_metodo}</td>
                <td style="font-weight:800;color:var(--green)">R$ ${parseFloat(p.total).toFixed(2).replace('.',',')}</td>
                <td><span class="badge badge-${p.status}">${STATUS_LABELS[p.status]||p.status}</span></td>
                <td style="color:var(--text3);font-size:12px">${new Date(p.criado_em).toLocaleDateString('pt-BR')} ${new Date(p.criado_em).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</td>
                <td style="white-space:nowrap;display:flex;gap:4px"><button class="btn btn-sm btn-orange" onclick="openDetail(${p.id})">Ver</button><button class="btn btn-sm btn-green" onclick="quickStatus(${p.id},'entregue',this)">Entregue</button><button class="btn btn-sm btn-red" onclick="quickDelete(${p.id},this)">Excluir</button></td>
            </tr>
        `).join('');

        // Pagination
        const totalPages = Math.ceil(data.total / 25);
        const pagDiv = document.getElementById('pagination');
        if(totalPages > 1) {
            let html = '';
            for(let i = 1; i <= totalPages; i++) {
                html += `<button class="btn btn-sm ${i===currentPage?'btn-orange':'btn-blue'}" onclick="currentPage=${i};loadPedidos()">${i}</button>`;
            }
            pagDiv.innerHTML = html;
        } else {
            pagDiv.innerHTML = '';
        }

    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="9" style="color:var(--red);text-align:center;padding:20px">Erro ao carregar pedidos</td></tr>';
    }
}

// Order Detail
async function openDetail(id) {
    const modal = document.getElementById('modal-detail');
    const content = document.getElementById('modal-content');
    content.innerHTML = '<div class="loading"><div class="spin"></div></div>';
    modal.classList.add('show');

    try {
        const res = await fetch(API+'/pedidos/'+id, {headers:{'x-admin-token':TOKEN}});
        const data = await res.json();
        const p = data.pedido;
        const hist = data.historico || [];

        const endereco = [p.endereco_rua, p.endereco_numero, p.endereco_bairro, p.endereco_cidade, p.endereco_estado].filter(Boolean).join(', ');

        content.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px">
                <div>
                    <h3 style="color:var(--orange)">${p.codigo}</h3>
                    <span class="badge badge-${p.status}">${STATUS_LABELS[p.status]||p.status}</span>
                </div>
                <button class="btn btn-sm" onclick="closeDetail()" style="background:var(--border);color:var(--text)">‚úï</button>
            </div>

            <div class="modal-row"><span class="label">Cesta</span><span class="value">${p.cesta_nome}</span></div>
            <div class="modal-row"><span class="label">Quantidade</span><span class="value">${p.quantidade}x</span></div>
            <div class="modal-row"><span class="label">Preco Unitario</span><span class="value">R$ ${parseFloat(p.cesta_preco).toFixed(2).replace('.',',')}</span></div>
            <div class="modal-row"><span class="label">Desconto</span><span class="value" style="color:var(--green)">${p.desconto > 0 ? '-R$ '+parseFloat(p.desconto).toFixed(2).replace('.',',') : '-'}</span></div>
            <div class="modal-row"><span class="label">Total</span><span class="value" style="font-size:16px;color:var(--green)">R$ ${parseFloat(p.total).toFixed(2).replace('.',',')}</span></div>

            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
                <div class="modal-row"><span class="label">Recebedor</span><span class="value">${p.recebedor_nome}</span></div>
                <div class="modal-row"><span class="label">Telefone</span><span class="value">${p.recebedor_telefone}</span></div>
                <div class="modal-row"><span class="label">Endereco</span><span class="value" style="white-space:normal;max-width:250px">${endereco}</span></div>
                ${p.endereco_referencia ? `<div class="modal-row"><span class="label">Referencia</span><span class="value">${p.endereco_referencia}</span></div>` : ''}
                ${p.endereco_complemento ? `<div class="modal-row"><span class="label">Complemento</span><span class="value">${p.endereco_complemento}</span></div>` : ''}
            </div>

            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
                <div class="modal-row"><span class="label">Pagamento</span><span class="value">${PAY_LABELS[p.pagamento_metodo]||p.pagamento_metodo}</span></div>
                <div class="modal-row"><span class="label">Pag. Status</span><span class="value">${p.pagamento_status}</span></div>
                ${p.cpf ? `<div class="modal-row"><span class="label">CPF</span><span class="value">${p.cpf}</span></div>` : ''}
                ${p.doc_identidade ? `<div class="modal-row"><span class="label">Doc Identidade</span><span class="value"><a href="/uploads/${p.doc_identidade}" target="_blank" class="doc-link">Ver documento</a></span></div>` : ''}
                ${p.doc_residencia ? `<div class="modal-row"><span class="label">Doc Residencia</span><span class="value"><a href="/uploads/${p.doc_residencia}" target="_blank" class="doc-link">Ver documento</a></span></div>` : ''}
            </div>

            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
                <div class="modal-row"><span class="label">Criado em</span><span class="value">${new Date(p.criado_em).toLocaleString('pt-BR')}</span></div>
                <div class="modal-row"><span class="label">Atualizado</span><span class="value">${new Date(p.atualizado_em).toLocaleString('pt-BR')}</span></div>
            </div>

            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
                <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;margin-bottom:10px">Mensagens WhatsApp</div>
                <div style="display:flex;flex-direction:column;gap:6px">
                    ${buildWhatsAppBtn(p, 'aceito', 'Pedido aceito', `Ol\u00e1, ${p.recebedor_nome}! Seu pedido ${p.codigo} da ${p.cesta_nome} foi recebido e aceito com sucesso. Estamos preparando tudo com muito cuidado para voc\u00ea. Em breve iniciaremos a separa\u00e7\u00e3o dos itens. Agradecemos a prefer\u00eancia! Araquari Cestas.`)}
                    ${buildWhatsAppBtn(p, 'separacao', 'Em separa\u00e7\u00e3o', `Ol\u00e1, ${p.recebedor_nome}! Temos boas not\u00edcias: a sua ${p.cesta_nome} (pedido ${p.codigo}) j\u00e1 est\u00e1 sendo preparada. Nossa equipe est\u00e1 selecionando cada item com aten\u00e7\u00e3o. Avisaremos assim que estiver pronta para o envio. Araquari Cestas.`)}
                    ${buildWhatsAppBtn(p, 'caminho', 'Saiu para entrega', `Ol\u00e1, ${p.recebedor_nome}! Sua ${p.cesta_nome} (pedido ${p.codigo}) acabou de sair para entrega. Nosso entregador est\u00e1 a caminho do endere\u00e7o informado. Por gentileza, fique atento para receb\u00ea-la. Qualquer d\u00favida, estamos \u00e0 disposi\u00e7\u00e3o. Araquari Cestas.`)}
                    ${buildWhatsAppBtn(p, 'entregue', 'Entrega confirmada', `Ol\u00e1, ${p.recebedor_nome}! Confirmamos que a sua ${p.cesta_nome} (pedido ${p.codigo}) foi entregue com sucesso. Esperamos que aproveite cada item! Caso precise de algo, n\u00e3o hesite em nos procurar. Obrigado por escolher a Araquari Cestas. At\u00e9 a pr\u00f3xima!`)}
                    ${buildWhatsAppBtn(p, 'problema', 'Informar problema', `Ol\u00e1, ${p.recebedor_nome}! Referente ao seu pedido ${p.codigo}, precisamos informar que ocorreu uma pend\u00eancia no processamento. Por favor, entre em contato conosco para que possamos resolver da melhor forma poss\u00edvel. Pedimos desculpas pelo transtorno. Araquari Cestas.`)}
                </div>
            </div>

            ${hist.length > 0 ? `
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
                <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;margin-bottom:8px">Historico</div>
                ${hist.map(h => `
                    <div class="hist-item">
                        <div class="hist-dot"></div>
                        <div>
                            <span style="font-weight:700">${h.status_anterior ? h.status_anterior+' ‚Üí ' : ''}${STATUS_LABELS[h.status_novo]||h.status_novo}</span>
                            ${h.observacao ? `<div style="color:var(--text3);margin-top:2px">${h.observacao}</div>` : ''}
                            <div style="color:var(--text3);margin-top:2px">${new Date(h.criado_em).toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                `).join('')}
            </div>` : ''}

            <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;margin-bottom:10px">Alterar Status</div>
                <select class="status-select" id="new-status">
                    <option value="">Selecione...</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="separacao">Em Separacao</option>
                    <option value="pronto">Pronto</option>
                    <option value="a_caminho">A Caminho</option>
                    <option value="entregue">Entregue</option>
                    <option value="cancelado">Cancelado</option>
                    ${p.pagamento_metodo === 'boleto30' ? '<option value="aprovado">Aprovar Boleto 30d</option><option value="recusado">Recusar Boleto 30d</option>' : ''}
                </select>
                <textarea class="obs-input" id="obs-status" placeholder="Observacao (opcional)"></textarea>
                <div class="modal-actions">
                    <button class="btn btn-green" onclick="updateStatus(${p.id})">Salvar Status</button>
                    <button class="btn" style="background:var(--border);color:var(--text)" onclick="closeDetail()">Fechar</button>
                </div>
            </div>
        `;
    } catch(e) {
        content.innerHTML = '<div style="color:var(--red);padding:20px">Erro ao carregar pedido</div>';
    }
}

async function updateStatus(id) {
    const status = document.getElementById('new-status').value;
    const obs = document.getElementById('obs-status').value;
    if(!status) { showToast('Selecione um status', 'warning'); return; }

    try {
        const res = await fetch(API+'/pedidos/'+id+'/status', {
            method: 'PATCH',
            headers: {'Content-Type':'application/json','x-admin-token':TOKEN},
            body: JSON.stringify({status, observacao: obs || null})
        });
        const data = await res.json();
        if(data.success) {
            showToast('Status atualizado com sucesso!', 'success');
            openDetail(id);
            loadPedidos();
            loadDashboard();
        } else {
            showToast('Erro: ' + data.error, 'error');
        }
    } catch(e) {
        showToast('Erro ao atualizar status', 'error');
    }
}

async function quickStatus(pedidoId, status, btn) {
    showConfirm('Alterar Status', 'Marcar pedido como ' + STATUS_LABELS[status] + '?', async () => {
        btn.disabled = true;
        btn.textContent = '...';
        try {
            const res = await fetch(API+'/pedidos/'+pedidoId+'/status', {
                method: 'PATCH',
                headers: {'Content-Type':'application/json','x-admin-token':TOKEN},
                body: JSON.stringify({status, observacao:'Atualizado via painel'})
            });
            const data = await res.json();
            if(data.success) { showToast('Status atualizado!', 'success'); loadDashboard(); loadPedidos(); }
            else { showToast('Erro: ' + data.error, 'error'); btn.disabled = false; btn.textContent = 'Entregue'; }
        } catch(e) { showToast('Erro ao atualizar', 'error'); btn.disabled = false; btn.textContent = 'Entregue'; }
    }, {icon:'\u2705', okText:'Confirmar'});
}

async function quickDelete(pedidoId, btn) {
    showConfirm('Excluir Pedido', 'Tem certeza que deseja EXCLUIR este pedido? Esta a\u00E7\u00E3o n\u00E3o pode ser desfeita.', async () => {
        btn.disabled = true;
        btn.textContent = '...';
        try {
            const res = await fetch(API+'/pedidos/'+pedidoId, {
                method: 'DELETE',
                headers: {'x-admin-token':TOKEN}
            });
            const data = await res.json();
            if(data.success) { showToast('Pedido exclu\u00EDdo!', 'success'); loadDashboard(); loadPedidos(); }
            else { showToast('Erro: ' + data.error, 'error'); btn.disabled = false; btn.textContent = 'Excluir'; }
        } catch(e) { showToast('Erro ao excluir', 'error'); btn.disabled = false; btn.textContent = 'Excluir'; }
    }, {icon:'\uD83D\uDDD1\uFE0F', okText:'Excluir', danger:true});
}

function buildWhatsAppBtn(p, tipo, label, mensagem) {
    const tel = (p.recebedor_telefone || '').replace(/\D/g, '');
    const telFormatado = tel.startsWith('55') ? tel : '55' + tel;
    const url = `https://wa.me/${telFormatado}?text=${encodeURIComponent(mensagem)}`;
    const cores = {
        aceito: '#3DA33D',
        separacao: '#E8850C',
        caminho: '#9b59b6',
        entregue: '#2ecc71',
        problema: '#e74c3c'
    };
    const cor = cores[tipo] || '#3498db';
    return `<a href="${url}" target="_blank" style="display:block;padding:10px 14px;background:${cor}18;border:1px solid ${cor}40;border-radius:10px;color:${cor};font-size:12px;font-weight:700;text-decoration:none;text-align:center;transition:.2s" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">${label}</a>`;
}

function closeDetail() {
    document.getElementById('modal-detail').classList.remove('show');
}

// Close modal on overlay click
document.getElementById('modal-detail').addEventListener('click', function(e) {
    if(e.target === this) closeDetail();
});

// Auto-refresh every 15s (order detection)
setInterval(() => {
    if(TOKEN && document.getElementById('admin-panel').style.display !== 'none') {
        loadDashboard();
        loadPedidos();
    }
}, 15000);
</script>
</body>
</html>
