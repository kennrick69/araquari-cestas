<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1A1A1A">
<title>Araquari Cestas</title>
<link rel="icon" type="image/png" href="assets/img/logo.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
    --bg: #0D0D0D;
    --bg2: #1A1A1A;
    --bg3: #242424;
    --card: #1E1E1E;
    --card2: #2A2A2A;
    --text: #FFFFFF;
    --text2: #B0B0B0;
    --text3: #707070;
    --orange: #E8850C;
    --orange-l: #F5A623;
    --orange-d: #C06A00;
    --green: #34C759;
    --green-d: #2DA44E;
    --blue: #4DB8E8;
    --red: #FF3B30;
    --yellow: #FFD93D;
    --border: rgba(255,255,255,0.08);
    --glass: rgba(26,26,26,0.85);
    --glass2: rgba(26,26,26,0.95);
    --radius: 16px;
    --radius-lg: 24px;
    --radius-xl: 32px;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'Plus Jakarta Sans',sans-serif; background:var(--bg); color:var(--text); overflow:hidden; height:100vh; height:100dvh; }
::-webkit-scrollbar { width:0; }

/* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
#splash {
    position:fixed; inset:0; z-index:9999;
    background:radial-gradient(ellipse at 50% 40%, #2A1A0A 0%, #0D0D0D 70%);
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    transition: opacity 0.8s ease, transform 0.8s ease;
    overflow:hidden;
}
#splash.hide { opacity:0; transform:scale(1.1); pointer-events:none; }

/* Floating food emojis background */
.splash-foods { position:absolute; inset:0; z-index:0; overflow:hidden; }
.splash-food {
    position:absolute; font-size:28px; opacity:0;
    animation: foodFall linear forwards;
}
@keyframes foodFall {
    0% { opacity:0; transform:translateY(-60px) rotate(0deg) scale(0.5); }
    10% { opacity:0.6; transform:translateY(0) scale(1); }
    90% { opacity:0.4; }
    100% { opacity:0; transform:translateY(calc(100vh + 60px)) rotate(360deg) scale(0.7); }
}

/* Glow rings behind logo */
.splash-glow {
    position:absolute; width:280px; height:280px; border-radius:50%; z-index:1;
    border:2px solid rgba(232,133,12,0.08);
    animation: glowPulse 2.5s ease-in-out infinite;
}
.splash-glow:nth-child(2) { width:360px; height:360px; animation-delay:0.4s; border-color:rgba(232,133,12,0.05); }
.splash-glow:nth-child(3) { width:440px; height:440px; animation-delay:0.8s; border-color:rgba(232,133,12,0.03); }
@keyframes glowPulse { 0%,100%{transform:scale(1);opacity:0.6} 50%{transform:scale(1.08);opacity:1} }

/* Center content */
.splash-center { position:relative; z-index:2; display:flex; flex-direction:column; align-items:center; text-align:center; }

.splash-logo-wrap {
    width:120px; height:120px; border-radius:30px; overflow:hidden;
    box-shadow: 0 0 60px rgba(232,133,12,0.3), 0 20px 60px rgba(0,0,0,0.5);
    animation: logoReveal 1s cubic-bezier(0.34,1.56,0.64,1) 0.3s both;
}
.splash-logo-wrap img { width:100%; height:100%; object-fit:contain; }
@keyframes logoReveal { from{opacity:0;transform:scale(0.3) rotateY(90deg)} to{opacity:1;transform:scale(1) rotateY(0)} }

.splash-brand {
    margin-top:20px; font-size:30px; font-weight:900; color:#fff; letter-spacing:-0.5px;
    animation: textReveal 0.8s ease 0.8s both;
}
.splash-brand span { color:var(--orange); }
@keyframes textReveal { from{opacity:0;transform:translateY(20px);filter:blur(10px)} to{opacity:1;transform:translateY(0);filter:blur(0)} }

.splash-tagline {
    margin-top:8px; font-size:14px; color:rgba(255,255,255,0.5); font-weight:600;
    animation: textReveal 0.8s ease 1.1s both;
}

/* Video preview window */
.splash-video-wrap {
    margin-top:24px; width:220px; height:220px; border-radius:22px; overflow:hidden;
    border:2px solid rgba(232,133,12,0.2);
    box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    animation: videoReveal 0.8s cubic-bezier(0.34,1.56,0.64,1) 1.4s both;
    background:#000;
}
.splash-video-wrap video { width:100%; height:100%; object-fit:cover; }
@keyframes videoReveal { from{opacity:0;transform:translateY(30px) scale(0.8)} to{opacity:1;transform:translateY(0) scale(1)} }

.splash-loader-bar {
    margin-top:32px; width:140px; height:4px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden;
    animation: textReveal 0.5s ease 1.8s both;
}
.splash-loader-fill {
    width:0%; height:100%; background:linear-gradient(90deg, var(--orange), var(--orange-l)); border-radius:2px;
    animation: loaderFill 2.5s ease 2s forwards;
}
@keyframes loaderFill { to{width:100%} }

@keyframes spin { to { transform:rotate(360deg); } }
@keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.05); } }

/* ‚îÄ‚îÄ APP CONTAINER ‚îÄ‚îÄ */
#app { position:fixed; inset:0; display:flex; flex-direction:column; }
.screen { position:absolute; inset:0; display:none; flex-direction:column; }
.screen.active { display:flex; animation:screenIn 0.4s ease-out; }
@keyframes screenIn { from { opacity:0; transform:translateX(30px); } to { opacity:1; transform:translateX(0); } }

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
#map-container { position:absolute; inset:0; z-index:0; }
#map-container .leaflet-container { height:100%; width:100%; }
.map-gradient-top { position:absolute; top:0; left:0; right:0; height:120px; background:linear-gradient(var(--bg),transparent); z-index:400; pointer-events:none; }
.map-gradient-bottom { position:absolute; bottom:0; left:0; right:0; height:200px; background:linear-gradient(transparent,var(--bg)); z-index:400; pointer-events:none; }

/* ‚îÄ‚îÄ CENTER PIN (overlay on map) ‚îÄ‚îÄ */
.center-pin { position:absolute; top:50%; left:50%; transform:translate(-50%,-100%); z-index:500; font-size:42px; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.5)); transition:transform 0.2s; pointer-events:none; }
.center-pin.bounce { animation:pinBounce 0.4s ease; }
@keyframes pinBounce { 0%{transform:translate(-50%,-100%)} 50%{transform:translate(-50%,-120%)} 100%{transform:translate(-50%,-100%)} }
.center-pin-shadow { position:absolute; top:50%; left:50%; transform:translate(-50%,2px); width:16px; height:6px; background:rgba(0,0,0,0.3); border-radius:50%; z-index:499; pointer-events:none; }

/* ‚îÄ‚îÄ HEADER BAR ‚îÄ‚îÄ */
.app-header {
    position:relative; z-index:500; padding:12px 20px; padding-top: max(12px, env(safe-area-inset-top));
    display:flex; align-items:center; justify-content:space-between;
}
.header-logo { display:flex; align-items:center; gap:10px; }
.header-logo img { width:38px; height:38px; border-radius:10px; }
.header-logo span { font-size:16px; font-weight:800; }
.header-btn { width:40px; height:40px; border-radius:12px; background:var(--glass); backdrop-filter:blur(20px); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; }
.header-right { display:flex; gap:8px; }

/* ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ */
.bottom-sheet {
    position:absolute; bottom:0; left:0; right:0; z-index:500;
    background:var(--bg); border-radius:var(--radius-xl) var(--radius-xl) 0 0;
    padding:12px 20px 24px; padding-bottom:max(24px, env(safe-area-inset-bottom));
    box-shadow:0 -8px 40px rgba(0,0,0,0.5);
    transition: transform 0.5s cubic-bezier(0.32,0.72,0,1);
    max-height:75vh; overflow-y:auto;
}
.bottom-sheet.collapsed { transform:translateY(calc(100% - 80px)); }
.sheet-handle { width:36px; height:4px; background:var(--text3); border-radius:2px; margin:0 auto 16px; }
.sheet-title { font-size:20px; font-weight:800; margin-bottom:4px; }
.sheet-sub { font-size:13px; color:var(--text2); font-weight:600; margin-bottom:20px; }

/* ‚îÄ‚îÄ BASKET CARDS ‚îÄ‚îÄ */
.basket-cards { display:flex; flex-direction:column; gap:12px; }
.basket-card {
    display:flex; align-items:center; gap:14px; padding:16px;
    background:var(--card); border-radius:var(--radius); cursor:pointer;
    border:2.5px solid transparent; transition:all 0.25s;
    position:relative; overflow:hidden;
}
.basket-card:hover, .basket-card:active { border-color:var(--orange); background:var(--card2); }
.basket-card.selected { border-color:var(--orange); background:rgba(232,133,12,0.08); }
.basket-icon { width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:28px; flex-shrink:0; }
.basket-info { flex:1; }
.basket-name { font-size:16px; font-weight:800; margin-bottom:2px; }
.basket-desc { font-size:12px; color:var(--text2); font-weight:500; }
.basket-items-preview { font-size:11px; color:var(--text3); margin-top:4px; font-weight:500; }
.basket-price { text-align:right; }
.basket-price-val { font-size:20px; font-weight:800; color:var(--orange); }
.basket-price-sub { font-size:11px; color:var(--text3); font-weight:600; }
.basket-tag { position:absolute; top:8px; right:8px; padding:3px 8px; border-radius:6px; font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:0.5px; }

/* ‚îÄ‚îÄ SEARCH / ADDRESS BAR ‚îÄ‚îÄ */
.address-bar {
    display:flex; align-items:center; gap:12px; padding:14px 16px;
    background:var(--card); border-radius:var(--radius); margin-bottom:16px; cursor:pointer;
    border:2px solid var(--border); transition:border 0.2s;
}
.address-bar:focus-within { border-color:var(--orange); }
.address-dot { width:10px; height:10px; border-radius:50%; background:var(--green); flex-shrink:0; box-shadow:0 0 8px rgba(52,199,89,0.4); }
.address-text { flex:1; }
.address-text-main { font-size:14px; font-weight:700; }
.address-text-sub { font-size:11px; color:var(--text3); font-weight:500; }
.address-arrow { color:var(--text3); font-size:16px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
    width:100%; padding:16px; border:none; border-radius:var(--radius); font-family:inherit;
    font-size:15px; font-weight:800; cursor:pointer; transition:all 0.2s;
    display:flex; align-items:center; justify-content:center; gap:8px;
}
.btn:active { transform:scale(0.97); }
.btn:disabled { opacity:0.4; cursor:not-allowed; transform:none !important; }
.btn-primary { background:var(--orange); color:#fff; }
.btn-primary:hover { background:var(--orange-l); }
.btn-green { background:var(--green); color:#fff; }
.btn-dark { background:var(--card2); color:var(--text); border:2px solid var(--border); }
.btn-ghost { background:transparent; color:var(--text2); }
.btn-sm { padding:10px 16px; font-size:13px; width:auto; }

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-group { margin-bottom:14px; }
.form-label { font-size:12px; font-weight:700; color:var(--text2); margin-bottom:6px; display:block; text-transform:uppercase; letter-spacing:0.5px; }
.form-label .req { color:var(--red); }
.form-input {
    width:100%; padding:14px 16px; background:var(--card); border:2px solid var(--border);
    border-radius:12px; color:var(--text); font-family:inherit; font-size:14px; font-weight:600; outline:none;
    transition:border 0.2s;
}
.form-input:focus { border-color:var(--orange); }
.form-input::placeholder { color:var(--text3); }

/* ‚îÄ‚îÄ PAYMENT METHODS ‚îÄ‚îÄ */
.pay-methods { display:flex; flex-direction:column; gap:10px; margin-bottom:20px; }
.pay-method {
    display:flex; align-items:center; gap:14px; padding:16px;
    background:var(--card); border-radius:var(--radius); cursor:pointer;
    border:2.5px solid transparent; transition:all 0.2s;
}
.pay-method.selected { border-color:var(--orange); background:rgba(232,133,12,0.06); }
.pay-emoji { font-size:28px; width:44px; height:44px; display:flex; align-items:center; justify-content:center; background:var(--bg3); border-radius:12px; }
.pay-info { flex:1; }
.pay-name { font-size:14px; font-weight:700; }
.pay-desc { font-size:11px; color:var(--text3); font-weight:500; margin-top:2px; }
.pay-check { width:22px; height:22px; border-radius:50%; border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:12px; transition:all 0.2s; }
.pay-method.selected .pay-check { background:var(--orange); border-color:var(--orange); }
.pay-tag { padding:3px 8px; border-radius:6px; font-size:9px; font-weight:800; }

/* ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ */
.file-upload {
    border:2px dashed var(--border); border-radius:12px; padding:20px 16px; text-align:center;
    cursor:pointer; transition:all 0.2s; background:var(--card); margin-bottom:12px;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
}
.file-upload.done { border-color:var(--green); background:rgba(52,199,89,0.06); }
.file-upload .upload-icon { font-size:22px; color:var(--text3); }
.file-upload p { font-size:12px; color:var(--text3); font-weight:600; margin:0; }
.file-upload .file-ok { font-size:13px; color:var(--green); font-weight:700; }

/* ‚îÄ‚îÄ ORDER STATUS ‚îÄ‚îÄ */
.status-screen { padding:20px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100%; background:var(--bg); }
.status-icon { font-size:80px; margin-bottom:20px; animation:pulse 2s infinite; }
.status-title { font-size:24px; font-weight:800; margin-bottom:8px; text-align:center; }
.status-sub { font-size:14px; color:var(--text2); text-align:center; max-width:300px; line-height:1.7; font-weight:600; margin-bottom:32px; }

/* ‚îÄ‚îÄ PAYMENT PROCESSING ‚îÄ‚îÄ */
.pix-box { background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px auto;max-width:340px;text-align:center; }
.pix-qr { width:220px;height:220px;margin:12px auto;border-radius:12px;background:#fff;padding:8px;display:flex;align-items:center;justify-content:center; }
.pix-qr img { width:100%;height:100%;object-fit:contain; }
.pix-code { background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:11px;word-break:break-all;color:var(--text2);margin:12px 0;max-height:60px;overflow:hidden;text-overflow:ellipsis; }
.pix-copy-btn { width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:10px;font-weight:800;font-size:14px;cursor:pointer;margin-top:8px; }
.pix-copy-btn:active { transform:scale(0.97); }
.boleto-box { background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px auto;max-width:340px;text-align:center; }
.boleto-barcode { background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px;word-break:break-all;color:var(--text2);margin:12px 0; }
.boleto-link-btn { display:block;width:100%;padding:12px;background:var(--orange);color:#fff;border:none;border-radius:10px;font-weight:800;font-size:14px;cursor:pointer;text-decoration:none;text-align:center;margin-top:8px; }
.card-form-box { background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px auto;max-width:340px; }
.card-input { width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;margin-bottom:10px; }
.card-input:focus { outline:none;border-color:var(--orange); }
.card-input::placeholder { color:var(--text3); }
.card-row { display:flex;gap:8px; }
.card-row .card-input { flex:1; }
.card-pay-btn { width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:10px;font-weight:800;font-size:14px;cursor:pointer;margin-top:6px; }
.card-pay-btn:disabled { background:var(--text3);cursor:not-allowed; }
.payment-waiting { display:flex;align-items:center;gap:8px;justify-content:center;margin:12px 0;font-size:13px;color:var(--green);font-weight:700; }
.payment-waiting .spin-sm { width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite;display:inline-block; }
.status-steps { width:100%; max-width:340px; margin-bottom:32px; }
.status-step { display:flex; align-items:flex-start; gap:14px; position:relative; padding-bottom:24px; }
.status-step:last-child { padding-bottom:0; }
.status-step::before { content:''; position:absolute; left:15px; top:34px; bottom:0; width:2px; background:var(--border); }
.status-step:last-child::before { display:none; }
.status-step.active::before { background:var(--orange); }
.status-step.done::before { background:var(--green); }
.step-dot { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; background:var(--card); border:2px solid var(--border); overflow:hidden; }
.status-step.done .step-dot { background:var(--green); border-color:var(--green); }
.status-step.active .step-dot { background:var(--orange); border-color:var(--orange); animation:pulse 2s infinite; }
.step-text { padding-top:4px; }
.step-title { font-size:14px; font-weight:700; }
.step-desc { font-size:11px; color:var(--text3); font-weight:500; margin-top:2px; }

/* ‚îÄ‚îÄ SUMMARY ROW ‚îÄ‚îÄ */
.summary { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:16px; }
.summary-row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
.summary-row span:first-child { color:var(--text2); font-size:13px; font-weight:600; }
.summary-row span:last-child { font-size:13px; font-weight:700; }
.summary-total { border-top:1px solid var(--border); margin-top:8px; padding-top:12px; }
.summary-total span:last-child { font-size:18px; color:var(--orange); }
.discount { color:var(--green) !important; }

/* ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ */
.back-btn { position:absolute; top:12px; left:16px; top:max(12px, env(safe-area-inset-top)); z-index:600; width:40px; height:40px; border-radius:50%; background:var(--glass); backdrop-filter:blur(20px); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; }

/* ‚îÄ‚îÄ BASKET DETAIL ‚îÄ‚îÄ */
.detail-hero { padding:20px; padding-top:max(60px, calc(env(safe-area-inset-top) + 48px)); text-align:center; }
.detail-icon-wrap { width:80px; height:80px; border-radius:22px; display:flex; align-items:center; justify-content:center; font-size:40px; margin:0 auto 14px; }
.detail-name { font-size:26px; font-weight:900; margin-bottom:2px; }
.detail-desc { font-size:13px; color:var(--text2); font-weight:600; }
.detail-price-row { display:flex; align-items:center; justify-content:center; gap:12px; margin-top:14px; }
.detail-price { font-size:32px; font-weight:900; color:var(--orange); }
.detail-price-pix { font-size:13px; color:var(--green); font-weight:700; background:rgba(52,199,89,0.1); padding:4px 10px; border-radius:8px; }

.detail-section-label { font-size:11px; font-weight:800; color:var(--text3); text-transform:uppercase; letter-spacing:1px; padding:16px 20px 10px; }

.detail-items { padding:0 20px; }
.detail-item {
    display:flex; align-items:center; justify-content:space-between;
    padding:13px 0; border-bottom:1px solid var(--border);
}
.detail-item:last-child { border-bottom:none; }
.detail-item-left { display:flex; align-items:center; gap:12px; }
.detail-item-dot { width:6px; height:6px; border-radius:50%; background:var(--orange); flex-shrink:0; }
.detail-item-name { font-size:14px; font-weight:600; }
.detail-item-qty { font-size:12px; color:var(--text3); font-weight:600; }

.detail-footer {
    position:sticky; bottom:0; padding:16px 20px; padding-bottom:max(16px, env(safe-area-inset-bottom));
    background:var(--bg2); border-top:1px solid var(--border);
    display:flex; align-items:center; gap:12px;
}
.qty-selector {
    display:flex; align-items:center; border:2px solid var(--border); border-radius:12px; overflow:hidden; background:var(--card);
}
.qty-btn { width:42px; height:42px; border:none; background:transparent; color:var(--text); font-size:18px; font-weight:800; cursor:pointer; font-family:inherit; }
.qty-btn:active { background:var(--bg3); }
.qty-val { width:36px; text-align:center; font-size:16px; font-weight:800; }

/* ‚îÄ‚îÄ DETAIL IMAGE ‚îÄ‚îÄ */
.detail-img-wrap {
    width:100%; max-height:200px; border-radius:16px; overflow:hidden;
    margin:0 20px 0; width:calc(100% - 40px);
    border:1px solid var(--border);
}
.detail-img-wrap img { width:100%; height:200px; object-fit:cover; cursor:pointer; }

/* ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ */
.lightbox { position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:9000; display:none; align-items:center; justify-content:center; flex-direction:column; }
.lightbox.show { display:flex; animation:fadeIn 0.25s; }
.lightbox img { max-width:92%; max-height:80vh; object-fit:contain; border-radius:12px; animation:lightboxIn 0.3s cubic-bezier(0.32,0.72,0,1); }
@keyframes lightboxIn { from{transform:scale(0.85);opacity:0} to{transform:scale(1);opacity:1} }
.lightbox-close { position:absolute; top:max(16px, env(safe-area-inset-top)); right:16px; width:40px; height:40px; border-radius:50%; background:rgba(255,255,255,0.12); border:none; color:#fff; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.detail-packaging {
    margin:12px 20px 0; padding:10px 14px; background:var(--card);
    border-radius:10px; font-size:12px; color:var(--text2); font-weight:600;
    display:flex; align-items:center; gap:8px;
}

/* ‚îÄ‚îÄ COMPARE MODAL ‚îÄ‚îÄ */
.compare-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:950; display:none; align-items:flex-end; justify-content:center; }
.compare-overlay.show { display:flex; animation:fadeIn 0.3s; }
.compare-sheet {
    width:100%; max-width:500px; max-height:85vh; background:var(--bg);
    border-radius:var(--radius-xl) var(--radius-xl) 0 0;
    padding:20px 0; animation:slideUp 0.4s cubic-bezier(0.32,0.72,0,1);
    display:flex; flex-direction:column;
}
.compare-header { padding:0 20px 16px; border-bottom:1px solid var(--border); }
.compare-body { overflow-x:auto; overflow-y:auto; flex:1; -webkit-overflow-scrolling:touch; }
.compare-table { width:100%; min-width:420px; border-collapse:collapse; font-size:12px; }
.compare-table thead { position:sticky; top:0; z-index:2; }
.compare-table th {
    padding:12px 8px; text-align:center; font-weight:800; font-size:11px;
    background:var(--bg2); border-bottom:2px solid var(--border); white-space:nowrap;
}
.compare-table th:first-child { text-align:left; padding-left:16px; min-width:140px; position:sticky; left:0; background:var(--bg2); z-index:3; }
.compare-table td { padding:10px 8px; text-align:center; border-bottom:1px solid var(--border); color:var(--text2); font-weight:500; }
.compare-table td:first-child { text-align:left; padding-left:16px; color:var(--text); font-weight:600; position:sticky; left:0; background:var(--bg); z-index:1; }
.compare-table .col-x { color:var(--green); font-weight:700; }
.compare-table .col-c { color:var(--orange); font-weight:700; }
.compare-table .col-p { color:var(--yellow); font-weight:700; }
.compare-table .has-item { color:var(--text); font-weight:600; }
.compare-table .no-item { color:var(--text3); }
.compare-price-row td { font-size:16px; font-weight:900; padding:14px 8px; border-top:2px solid var(--border); background:var(--bg2); }
.compare-price-row td:first-child { background:var(--bg2); }

/* ‚îÄ‚îÄ CONFIRM ADDRESS MODAL ‚îÄ‚îÄ */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:900; display:none; align-items:flex-end; justify-content:center; }
.modal-overlay.show { display:flex; animation:fadeIn 0.3s; }
.modal { width:100%; max-width:500px; background:var(--bg); border-radius:var(--radius-xl) var(--radius-xl) 0 0; padding:24px 20px; padding-bottom:max(24px, env(safe-area-inset-bottom)); animation:slideUp 0.4s cubic-bezier(0.32,0.72,0,1); }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (min-width:500px) {
    body { display:flex; justify-content:center; background:#000; }
    #app { max-width:430px; position:relative; border-left:1px solid #222; border-right:1px solid #222; }
    #splash { max-width:430px; left:50%; transform:translateX(-50%); }
    #splash.hide { transform:translateX(-50%) scale(1.1); }
}
/* ‚ïê‚ïê‚ïê DONATION MODE (golden theme) ‚ïê‚ïê‚ïê */
body.donation-mode .bottom-sheet { background:linear-gradient(180deg, #1a1400 0%, #0a0a0f 40%) !important; border-top:2px solid rgba(212,175,55,0.4) !important; }
body.donation-mode .sheet-title { color:#D4AF37 !important; }
body.donation-mode .sheet-sub { color:rgba(212,175,55,0.7) !important; }
body.donation-mode .basket-card { border-color:rgba(212,175,55,0.25) !important; background:rgba(212,175,55,0.04) !important; }
body.donation-mode .basket-card:hover, body.donation-mode .basket-card.selected { border-color:#D4AF37 !important; box-shadow:0 0 20px rgba(212,175,55,0.15) !important; }
body.donation-mode .basket-price-val { color:#D4AF37 !important; }
body.donation-mode .basket-price-sub { color:rgba(212,175,55,0.6) !important; }
body.donation-mode .app-header { background:linear-gradient(180deg, rgba(26,20,0,0.95), transparent) !important; }
body.donation-mode .header-logo span { color:#D4AF37 !important; }
body.donation-mode .detail-name { color:#D4AF37 !important; }
body.donation-mode .detail-price { color:#D4AF37 !important; }
body.donation-mode .btn-primary { background:#D4AF37 !important; color:#1a1400 !important; }
body.donation-mode .detail-footer { border-top-color:rgba(212,175,55,0.2) !important; }
body.donation-mode .back-btn { border-color:rgba(212,175,55,0.3) !important; }
.donation-banner { background:linear-gradient(135deg,rgba(212,175,55,0.12),rgba(212,175,55,0.04)); border:1px solid rgba(212,175,55,0.25); border-radius:12px; padding:12px 16px; margin-bottom:16px; text-align:center; }
.donation-banner-text { font-size:13px; color:#D4AF37; font-weight:700; }
.donation-banner-sub { font-size:11px; color:rgba(212,175,55,0.7); margin-top:4px; line-height:1.5; }
.btn-donate { background:linear-gradient(135deg,#D4AF37,#b8962e) !important; color:#1a1400 !important; font-weight:800 !important; border:none; }
.btn-donate-outline { background:transparent; border:1.5px solid #D4AF37; color:#D4AF37; font-weight:700; }
.btn-donate-outline:hover { background:rgba(212,175,55,0.1); }
/* ‚ïê‚ïê‚ïê TOAST & CONFIRM MODAL ‚ïê‚ïê‚ïê */
.app-toast { position:fixed; top:0; left:50%; transform:translateX(-50%) translateY(-100%); z-index:99999; padding:14px 20px; border-radius:0 0 16px 16px; font-size:13px; font-weight:700; max-width:400px; width:100%; text-align:center; transition:transform .35s cubic-bezier(.22,1,.36,1); line-height:1.5; box-shadow:0 8px 30px rgba(0,0,0,.4); }
.app-toast.show { transform:translateX(-50%) translateY(0); }
.app-toast.success { background:linear-gradient(135deg,#1a3a1a,#0d2e0d); color:#34c759; border-bottom:2px solid #34c759; }
.app-toast.error { background:linear-gradient(135deg,#3a1a1a,#2e0d0d); color:#ff453a; border-bottom:2px solid #ff453a; }
.app-toast.warning { background:linear-gradient(135deg,#3a2e1a,#2e200d); color:#E8850C; border-bottom:2px solid #E8850C; }
.app-toast.info { background:linear-gradient(135deg,#1a2a3a,#0d1e2e); color:#64d2ff; border-bottom:2px solid #64d2ff; }
.confirm-overlay { position:fixed; inset:0; z-index:99998; background:rgba(0,0,0,.7); backdrop-filter:blur(6px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity .25s; }
.confirm-overlay.show { opacity:1; pointer-events:auto; }
.confirm-box { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:28px 24px 20px; max-width:320px; width:90%; text-align:center; transform:scale(.9); transition:transform .25s; }
.confirm-overlay.show .confirm-box { transform:scale(1); }
.confirm-icon { font-size:36px; margin-bottom:10px; }
.confirm-title { font-size:15px; font-weight:800; color:var(--text); margin-bottom:6px; }
.confirm-msg { font-size:13px; color:var(--text2); line-height:1.6; margin-bottom:18px; }
.confirm-btns { display:flex; gap:10px; }
.confirm-btns .btn { flex:1; padding:12px; font-size:13px; font-weight:800; border-radius:12px; border:none; cursor:pointer; }
.confirm-btn-cancel { background:var(--border); color:var(--text); }
.confirm-btn-ok { background:var(--orange); color:#fff; }
.confirm-btn-danger { background:var(--red); color:#fff; }
</style>
<script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPLASH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="splash">
    <!-- Floating food emojis -->
    <div class="splash-foods" id="splash-foods"></div>

    <!-- Glow rings -->
    <div class="splash-glow"></div>
    <div class="splash-glow"></div>
    <div class="splash-glow"></div>

    <!-- Center content -->
    <div class="splash-center">
        <div class="splash-logo-wrap"><img src="assets/img/logo.png" alt="Logo"></div>
        <div class="splash-brand">Araquari <span>Cestas</span></div>
        <div class="splash-tagline">üõí Cesta b√°sica na sua porta</div>
        <div class="splash-video-wrap">
            <video autoplay muted playsinline loop id="splash-video">
                <source src="assets/video/splash.mp4" type="video/mp4">
            </video>
        </div>
        <div class="splash-loader-bar"><div class="splash-loader-fill"></div></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">

    <!-- MAP (always present behind everything) -->
    <div id="map-container"><div id="map"></div></div>
    <div class="map-gradient-top"></div>
    <div class="center-pin" id="center-pin" style="display:none">üìç</div>
    <div class="center-pin-shadow" id="center-pin-shadow" style="display:none"></div>

    <!-- ‚ïê‚ïê‚ïê SCREEN: HOME ‚ïê‚ïê‚ïê -->
    <div id="screen-home" class="screen active">
        <div class="app-header">
            <div class="header-logo">
                <img src="assets/img/logo.png" alt="">
                <span>Araquari Cestas</span>
            </div>
            <div class="header-right">
                <div class="header-btn" onclick="showScreen('orders')"><img src="assets/img/nav-pedidos.png" style="width:22px;height:22px"></div>
                <div class="header-btn"><img src="assets/img/nav-conta.png" style="width:22px;height:22px"></div>
            </div>
        </div>

        <div class="bottom-sheet" id="home-sheet">
            <div class="sheet-handle"></div>
            <div class="sheet-title">Escolha sua cesta üõí</div>
            <div class="sheet-sub">Selecione o tipo e pe√ßa agora</div>

            <!-- Action buttons row -->
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <button class="btn btn-sm btn-dark" onclick="openCompare()" style="flex:1;padding:8px 12px;font-size:12px;border-radius:10px"><img src="assets/img/nav-comparar.png" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"> Comparar</button>
                <button class="btn btn-sm btn-donate-outline" id="btn-toggle-donate" onclick="toggleDonationMode()" style="flex:1;padding:8px 12px;font-size:12px;border-radius:10px"><img src="assets/img/nav-doacao.png" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"> Doar cesta</button>
            </div>

            <!-- Donation mode banner (hidden by default) -->
            <div class="donation-banner" id="donation-mode-banner" style="display:none">
                <div class="donation-banner-text">&#x2764;&#xFE0F; Modo Doa&#xE7;&#xE3;o Ativado</div>
                <div class="donation-banner-sub">Escolha a cesta que deseja doar. N&#xF3;s encontraremos uma fam&#xED;lia que precisa na regi&#xE3;o de Araquari.</div>
            </div>

            <!-- Basket cards -->
            <div class="basket-cards">
                <div class="basket-card" onclick="selectBasket('x')" id="card-x">
                    <div class="basket-icon" style="background:rgba(52,199,89,0.12)"><img src="assets/img/icon-cesta-x.svg" style="width:36px;height:36px"></div>
                    <div class="basket-info">
                        <div class="basket-name">Cesta X</div>
                        <div class="basket-desc">Essencial ¬∑ 11 itens</div>
                        <div class="basket-items-preview">Arroz, Feij√£o, Caf√©, √ìleo, Sardinha...</div>
                    </div>
                    <div class="basket-price">
                        <div class="basket-price-val">R$ 1<small>,00</small></div>
                        <div class="basket-price-sub">√† vista</div>
                    </div>
                </div>

                <div class="basket-card" onclick="selectBasket('confort')" id="card-confort">
                    <div class="basket-icon" style="background:rgba(232,133,12,0.12)"><img src="assets/img/icon-cesta-confort.svg" style="width:36px;height:36px"></div>
                    <div class="basket-info">
                        <div class="basket-name">Cesta Confort</div>
                        <div class="basket-desc">Fam√≠lia ¬∑ 14 itens</div>
                        <div class="basket-items-preview">Arroz 5kg, Feij√£o, Caf√©, 2x √ìleo, Fub√°...</div>
                    </div>
                    <div class="basket-price">
                        <div class="basket-price-val">R$ 2<small>,00</small></div>
                        <div class="basket-price-sub">√† vista</div>
                    </div>
                    <div class="basket-tag" style="background:rgba(232,133,12,0.15);color:var(--orange)">POPULAR</div>
                </div>

                <div class="basket-card" onclick="selectBasket('plus')" id="card-plus">
                    <div class="basket-icon" style="background:rgba(255,217,61,0.12)"><img src="assets/img/icon-cesta-plus.svg" style="width:36px;height:36px"></div>
                    <div class="basket-info">
                        <div class="basket-name">Cesta Plus</div>
                        <div class="basket-desc">Premium ¬∑ 33 itens</div>
                        <div class="basket-items-preview">Completa + higiene e limpeza</div>
                    </div>
                    <div class="basket-price">
                        <div class="basket-price-val">R$ 3<small>,00</small></div>
                        <div class="basket-price-sub">√† vista</div>
                    </div>
                    <div class="basket-tag" style="background:rgba(255,217,61,0.15);color:var(--yellow)">‚≠ê PREMIUM</div>
                </div>
            </div>

            <div style="margin-top:14px;font-size:10px;color:var(--text3);line-height:1.5;font-weight:500;text-align:center">
                *Imagens ilustrativas. As marcas e valores podem sofrer altera√ß√µes de acordo com a disponibilidade.
            </div>

            <div style="height:12px"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN: MAP (choose address) ‚ïê‚ïê‚ïê -->
    <div id="screen-map" class="screen" style="pointer-events:none">
        <div class="back-btn" style="pointer-events:auto" onclick="showScreen('home')">‚Üê</div>

        <div class="app-header" style="justify-content:center;pointer-events:none">
            <div style="background:var(--glass);backdrop-filter:blur(20px);padding:8px 20px;border-radius:50px;border:1px solid var(--border);pointer-events:auto">
                <span style="font-size:13px;font-weight:700">üìç Mova o mapa para ajustar</span>
            </div>
        </div>

        <!-- GPS button -->
        <div style="position:absolute;bottom:200px;right:16px;z-index:500;pointer-events:auto">
            <div class="header-btn" onclick="centerOnUser()" style="width:48px;height:48px;border-radius:50%;font-size:20px;background:var(--glass2);backdrop-filter:blur(20px)"><img src="assets/img/nav-gps.png" style="width:24px;height:24px"></div>
        </div>

        <div class="bottom-sheet" style="max-height:50vh;pointer-events:auto">
            <div class="sheet-handle"></div>
            <div class="sheet-title">Onde deseja entregar? üìç</div>
            <div class="sheet-sub">Arraste o mapa para posicionar o pin no local exato</div>

            <div class="address-bar" style="cursor:default;margin-bottom:12px">
                <div class="address-dot"></div>
                <div class="address-text">
                    <div class="address-text-main" id="map-address">Buscando endere√ßo...</div>
                    <div class="address-text-sub" id="map-address-sub">Mova o mapa para atualizar</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="confirmAddress()" id="btn-confirm-address">Confirmar local de entrega</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN: PAYMENT ‚ïê‚ïê‚ïê -->
    <div id="screen-payment" class="screen" style="background:var(--bg);overflow-y:auto">
        <div class="back-btn" onclick="goBackFromDetail()">‚Üê</div>

        <div style="padding:20px;padding-top:max(60px, calc(env(safe-area-inset-top) + 48px))">
            <div class="sheet-title" id="payment-title">Pagamento üí≥</div>
            <div class="sheet-sub" id="payment-sub">Escolha como deseja pagar</div>

            <!-- Order summary -->
            <div class="summary" id="payment-summary"></div>

            <!-- Payment methods -->
            <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Forma de pagamento</div>
            <div class="pay-methods">
                <div class="pay-method" onclick="selectPay('pix')" id="pay-pix">
                    <div class="pay-emoji"><img src="assets/img/pay-pix.png" style="width:32px;height:32px"></div>
                    <div class="pay-info">
                        <div class="pay-name">PIX</div>
                        <div class="pay-desc">Aprova√ß√£o instant√¢nea</div>
                    </div>
                    <span class="pay-tag" style="background:rgba(52,199,89,0.12);color:var(--green)">5% OFF</span>
                    <div class="pay-check"></div>
                </div>
                <div class="pay-method" onclick="selectPay('cartao')" id="pay-cartao">
                    <div class="pay-emoji"><img src="assets/img/pay-cartao.png" style="width:32px;height:32px"></div>
                    <div class="pay-info">
                        <div class="pay-name">Cart√£o de Cr√©dito</div>
                        <div class="pay-desc">At√© 3x sem juros</div>
                    </div>
                    <div class="pay-check"></div>
                </div>
                <div class="pay-method" onclick="selectPay('boleto')" id="pay-boleto">
                    <div class="pay-emoji"><img src="assets/img/pay-boleto.png" style="width:32px;height:32px"></div>
                    <div class="pay-info">
                        <div class="pay-name">Boleto √† Vista</div>
                        <div class="pay-desc">Vencimento 3 dias √∫teis</div>
                    </div>
                    <div class="pay-check"></div>
                </div>
                <div class="pay-method" onclick="selectPay('boleto30')" id="pay-boleto30">
                    <div class="pay-emoji"><img src="assets/img/pay-boleto30.png" style="width:32px;height:32px"></div>
                    <div class="pay-info">
                        <div class="pay-name">Boleto 30 Dias</div>
                        <div class="pay-desc">Pague em at√© 30 dias</div>
                    </div>
                    <span class="pay-tag" style="background:rgba(232,133,12,0.12);color:var(--orange)">CADASTRO</span>
                    <div class="pay-check"></div>
                </div>
            </div>

            <!-- CPF for boleto √† vista (hidden by default) -->
            <div id="boleto-cpf-area" style="display:none;margin-bottom:14px">
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">CPF do pagador <span class="req">*</span></label>
                    <input class="form-input" placeholder="000.000.000-00" id="input-cpf-boleto" inputmode="numeric" oninput="this.value=maskCPF(this.value)">
                </div>
            </div>

            <!-- Boleto 30 dias: document upload area (hidden by default) -->
            <div id="boleto30-area" style="display:none">
                <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Documentos obrigat√≥rios</div>
                <div style="background:rgba(232,133,12,0.06);border:1px solid rgba(232,133,12,0.15);border-radius:12px;padding:12px 16px;margin-bottom:14px;font-size:12px;color:var(--orange);font-weight:600">
                    ‚ö†Ô∏è Para boleto 30 dias √© necess√°rio enviar seus documentos para an√°lise de cr√©dito.
                </div>

                <div class="form-group">
                    <label class="form-label">CPF <span class="req">*</span></label>
                    <input class="form-input" placeholder="000.000.000-00" id="input-cpf" oninput="this.value=maskCPF(this.value)">
                </div>

                <label class="file-upload" id="upload-doc">
                    <input type="file" accept=".jpg,.png,.pdf" style="display:none" onchange="handleUpload('doc',this)">
                    <div class="upload-icon"><img src="assets/img/nav-upload.png" style="width:22px;height:22px"></div>
                    <p>RG ou CNH (foto ou PDF)</p>
                </label>
                <label class="file-upload" id="upload-res">
                    <input type="file" accept=".jpg,.png,.pdf" style="display:none" onchange="handleUpload('res',this)">
                    <div class="upload-icon"><img src="assets/img/nav-upload.png" style="width:22px;height:22px"></div>
                    <p>Comprovante de Resid√™ncia</p>
                </label>
            </div>

            <button class="btn btn-primary" id="btn-pay" onclick="finalizePay()" disabled>Finalizar Pedido</button>
            <div style="height:40px"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN: STATUS ‚ïê‚ïê‚ïê -->
    <div id="screen-status" class="screen">
        <div class="status-screen" id="status-content"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN: BASKET DETAIL ‚ïê‚ïê‚ïê -->
    <div id="screen-detail" class="screen" style="background:var(--bg);overflow-y:auto">
        <div class="back-btn" onclick="goBackFromDetail()">‚Üê</div>
        <div id="detail-content"></div>
        <div class="detail-footer" id="detail-footer"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN: ORDERS (history) ‚ïê‚ïê‚ïê -->
    <div id="screen-orders" class="screen" style="background:var(--bg);overflow-y:auto">
        <div class="back-btn" onclick="showScreen('home')">‚Üê</div>
        <div style="padding:20px;padding-top:max(60px, calc(env(safe-area-inset-top) + 48px))">
            <div class="sheet-title">Meus Pedidos üì¶</div>
            <div class="sheet-sub">Consulte pelo c√≥digo ou telefone</div>

            <div class="form-group" style="margin-top:16px">
                <input class="form-input" placeholder="C√≥digo do pedido ou telefone" id="input-busca-pedido" style="text-align:center;font-weight:700;letter-spacing:0.5px">
            </div>
            <button class="btn btn-primary" onclick="buscarPedidos()" style="margin-bottom:20px">Buscar</button>

            <div id="orders-list" style="text-align:center;padding:20px;color:var(--text3)">
                <div style="font-size:56px;margin-bottom:12px">üì≠</div>
                <p style="font-weight:600">Nenhum pedido ainda</p>
                <p style="font-size:12px;margin-top:4px">Digite seu telefone ou c√≥digo do pedido acima</p>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê CONFIRM ADDRESS MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-address">
    <div class="modal">
        <div style="text-align:center;margin-bottom:20px">
            <div style="margin-bottom:8px"><img src="assets/img/nav-local.png" style="width:48px;height:48px"></div>
            <div style="font-size:18px;font-weight:800">Confirme o endere√ßo</div>
        </div>

        <div class="address-bar" style="cursor:default;margin-bottom:16px">
            <div class="address-dot"></div>
            <div class="address-text">
                <div class="address-text-main" id="modal-address-main">Rua Exemplo, 123</div>
                <div class="address-text-sub" id="modal-address-sub">Centro, Araquari - SC</div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Quem vai receber <span class="req">*</span></label>
            <input class="form-input" placeholder="Nome completo de quem recebe" id="input-recebedor">
        </div>
        <div class="form-group">
            <label class="form-label">Telefone de contato <span class="req">*</span></label>
            <input class="form-input" placeholder="(00) 00000-0000" id="input-telefone" inputmode="tel" oninput="this.value=maskPhone(this.value)">
        </div>
        <div class="form-group">
            <label class="form-label">N√∫mero <span class="req">*</span></label>
            <input class="form-input" placeholder="N¬∫ da casa/apto" id="input-numero" inputmode="numeric" type="text">
        </div>
        <div class="form-group">
            <label class="form-label">Ponto de refer√™ncia <span class="req">*</span></label>
            <input class="form-input" placeholder="Ex: pr√≥ximo ao mercado, casa azul..." id="input-ref">
        </div>
        <div class="form-group">
            <label class="form-label">Complemento</label>
            <input class="form-input" placeholder="Apto, bloco, fundos..." id="input-comp">
        </div>

        <div style="display:flex;gap:10px;margin-top:8px">
            <button class="btn btn-dark" style="flex:1" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" style="flex:2" onclick="saveAddress()">‚úì Confirmar endere√ßo</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê DONATION CONTACT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-donation-contact">
    <div class="modal" style="max-width:380px">
        <div style="text-align:center;margin-bottom:16px">
            <div style="font-size:48px;margin-bottom:8px">&#x2764;&#xFE0F;</div>
            <div style="font-size:18px;font-weight:800;color:var(--green)">Que lindo gesto!</div>
            <div style="font-size:13px;color:var(--text2);margin-top:8px;line-height:1.6">
                Gostaria de saber qual fam&#xED;lia foi beneficiada e onde a cesta foi entregue?
            </div>
        </div>

        <div id="donation-contact-fields" style="display:none">
            <div style="background:rgba(61,163,61,0.08);border:1px solid rgba(61,163,61,0.2);border-radius:12px;padding:14px;margin-bottom:16px">
                <div style="font-size:12px;color:var(--green);font-weight:700;margin-bottom:4px">&#x1F4E9; Como funciona:</div>
                <div style="font-size:12px;color:var(--text2);line-height:1.6">
                    Assim que a cesta for entregue, enviaremos pelo WhatsApp os dados da fam&#xED;lia beneficiada, foto da entrega e localiza&#xE7;&#xE3;o.
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Seu nome</label>
                <input class="form-input" placeholder="Como devemos te chamar?" id="input-donor-name">
            </div>
            <div class="form-group">
                <label class="form-label">Seu WhatsApp</label>
                <input class="form-input" placeholder="(00) 00000-0000" id="input-donor-phone" inputmode="tel" oninput="this.value=maskPhone(this.value)">
            </div>
            <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="confirmDonationContact()">
                Continuar para pagamento
            </button>
            <button class="btn btn-dark" style="width:100%;margin-top:8px;font-size:12px" onclick="skipDonationContact()">
                Prefiro n&#xE3;o informar
            </button>
        </div>

        <div id="donation-contact-buttons">
            <button class="btn btn-primary" style="width:100%;padding:14px" onclick="showDonationContactFields()">
                Sim, quero saber!
            </button>
            <button class="btn btn-dark" style="width:100%;margin-top:10px;font-size:13px" onclick="skipDonationContact()">
                N&#xE3;o precisa, apenas quero doar &#x2764;&#xFE0F;
            </button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê LIGHTBOX ‚ïê‚ïê‚ïê -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
    <img id="lightbox-img" src="" alt="">
</div>

<!-- ‚ïê‚ïê‚ïê COMPARE MODAL ‚ïê‚ïê‚ïê -->
<div class="compare-overlay" id="modal-compare" onclick="if(event.target===this)closeCompare()">
    <div class="compare-sheet">
        <div class="compare-header">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                    <div style="font-size:18px;font-weight:800">üìä Comparativo de Cestas</div>
                    <div style="font-size:12px;color:var(--text3);margin-top:2px">Deslize para ver todas</div>
                </div>
                <div class="header-btn" onclick="closeCompare()" style="font-size:14px;cursor:pointer">‚úï</div>
            </div>
        </div>
        <div class="compare-body">
            <table class="compare-table" id="compare-table-body"></table>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="app-toast" id="app-toast"></div>

<!-- Confirm modal -->
<div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-box">
        <div class="confirm-icon" id="confirm-icon"></div>
        <div class="confirm-title" id="confirm-title"></div>
        <div class="confirm-msg" id="confirm-msg"></div>
        <div class="confirm-btns">
            <button class="btn confirm-btn-cancel" id="confirm-cancel">Cancelar</button>
            <button class="btn confirm-btn-ok" id="confirm-ok">Confirmar</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST & CONFIRM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer = null;
function showToast(msg, type='info', duration=3500) {
    const t = document.getElementById('app-toast');
    t.className = 'app-toast ' + type;
    const icons = {success:'\u2705',error:'\u274C',warning:'\u26A0\uFE0F',info:'\u2139\uFE0F'};
    t.innerHTML = (icons[type]||'') + ' ' + msg;
    clearTimeout(toastTimer);
    requestAnimationFrame(() => { t.classList.add('show'); });
    toastTimer = setTimeout(() => t.classList.remove('show'), duration);
}
function showConfirm(title, msg, onOk, opts={}) {
    const ov = document.getElementById('confirm-overlay');
    document.getElementById('confirm-icon').textContent = opts.icon || '\u26A0\uFE0F';
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-msg').textContent = msg;
    const okBtn = document.getElementById('confirm-ok');
    const cancelBtn = document.getElementById('confirm-cancel');
    okBtn.textContent = opts.okText || 'Confirmar';
    okBtn.className = 'btn ' + (opts.danger ? 'confirm-btn-danger' : 'confirm-btn-ok');
    cancelBtn.textContent = opts.cancelText || 'Cancelar';
    ov.classList.add('show');
    const close = () => { ov.classList.remove('show'); okBtn.onclick = null; cancelBtn.onclick = null; };
    okBtn.onclick = () => { close(); if(onOk) onOk(); };
    cancelBtn.onclick = close;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const API_URL = '/api';

const state = {
    basket: null,
    address: null,
    addressFull: null,
    lat: null,
    lng: null,
    payMethod: null,
    qty: 1,
    uploads: { doc:false, res:false },
    uploadFiles: { doc:null, res:null },
    pedidoCodigo: null,
    isDonation: false,
    donorContact: null
};

const BASKETS = {
    x: {
        name:"Cesta X", price:1.00, emoji:"üçö", desc:"Essencial ¬∑ 11 itens", color:"var(--green)",
        img:"assets/img/cesta-x.png",
        items:[
            { name:"A√ß√∫car Refinado Especial", qty:"1x 1 kg" },
            { name:"Arroz Parboilizado Tipo 1", qty:"2x 1 kg" },
            { name:"Biscoito Recheado Chocolate", qty:"1x 140 g" },
            { name:"Caf√© em P√≥ Extra Forte", qty:"1x 500 g" },
            { name:"Feij√£o Carioca Tipo 1", qty:"1x 1 kg" },
            { name:"Fub√° Mimoso Fino", qty:"1x 500 g" },
            { name:"Macarr√£o Espaguete com Ovos", qty:"1x 500 g" },
            { name:"Molho de Tomate Refogado Tradicional", qty:"1x 340 g" },
            { name:"√ìleo de Soja PET", qty:"1x 900 ml" },
            { name:"Sal Refinado Iodado", qty:"1x 1 kg" },
            { name:"Sardinha em √ìleo Lata Abre F√°cil", qty:"1x 125 g" },
        ],
        packaging:"Embalagem Saco Pl√°stico Transparente"
    },
    confort: {
        name:"Cesta Confort", price:2.00, emoji:"üõí", desc:"Fam√≠lia ¬∑ 14 itens", color:"var(--orange)",
        img:"assets/img/cesta-confort.png",
        items:[
            { name:"A√ß√∫car Refinado Especial", qty:"2x 1 kg" },
            { name:"Arroz Parboilizado Tipo 1", qty:"1x 5 kg" },
            { name:"Biscoito Sortido", qty:"1x 280 g" },
            { name:"Caf√© em P√≥ Extra Forte a V√°cuo", qty:"1x 500 g" },
            { name:"Farinha de Milho Amarelo", qty:"1x 1 kg" },
            { name:"Farinha de Trigo Tipo 1 Tradicional", qty:"1x 1 kg" },
            { name:"Feij√£o Preto Tipo 1", qty:"1x 1 kg" },
            { name:"Fub√° Amarelo", qty:"1x 1 kg" },
            { name:"Macarr√£o Espaguete com Ovos", qty:"1x 500 g" },
            { name:"Macarr√£o Parafuso com Ovos", qty:"1x 500 g" },
            { name:"Molho de Tomate Refogado Sach√™", qty:"1x 340 g" },
            { name:"√ìleo de Soja PET", qty:"2x 900 ml" },
            { name:"Refresco em P√≥ Morango", qty:"1x 25 g" },
            { name:"Sardinha em √ìleo Lata Abre F√°cil", qty:"1x 125 g" },
        ],
        packaging:"Caixa de Papel√£o Corrugado Duplo"
    },
    plus: {
        name:"Cesta Plus", price:3.00, emoji:"üëë", desc:"Premium ¬∑ 33 itens", color:"var(--yellow)",
        img:"assets/img/cesta-plus.png",
        items:[
            { name:"Achocolatado em P√≥", qty:"1x 370 g" },
            { name:"A√ß√∫car Cristal Branco", qty:"1x 5 kg" },
            { name:"√Ågua Sanit√°ria", qty:"1x 1 l" },
            { name:"Arroz Parboilizado Tipo 1", qty:"1x 5 kg" },
            { name:"Biscoito Recheado Chocolate", qty:"1x 140 g" },
            { name:"Caf√© em P√≥ Tradicional a V√°cuo", qty:"1x 500 g" },
            { name:"Creme Dental Tripla Limpeza", qty:"2x 70 g" },
            { name:"Creme de Leite Leve UHT", qty:"1x 200 g" },
            { name:"Desinfetante 3 em 1", qty:"1x 500 ml" },
            { name:"Detergente Neutro", qty:"2x 500 ml" },
            { name:"Ervilha em Conserva Lata", qty:"1x 200 g" },
            { name:"Esponja Dupla Face", qty:"1x 7x10 cm" },
            { name:"Farinha de Milho Amarelo", qty:"1x 1 kg" },
            { name:"Farinha de Trigo", qty:"1x 1 kg" },
            { name:"Farofa Temperada", qty:"1x 250 g" },
            { name:"Feij√£o Preto Tipo 1", qty:"2x 1 kg" },
            { name:"Fub√° Mimoso Fino", qty:"1x 1 kg" },
            { name:"Gelatina Morango", qty:"1x 20 g" },
            { name:"L√£ de A√ßo c/ 8 Unidades", qty:"1x 60 g" },
            { name:"Leite Condensado Semi Desnatado", qty:"1x 395 g" },
            { name:"Macarr√£o Espaguete com Ovos", qty:"2x 500 g" },
            { name:"Macarr√£o Parafuso com Ovos", qty:"1x 500 g" },
            { name:"Milho Verde em Conserva Lata", qty:"1x 170 g" },
            { name:"Molho de Tomate Tradicional", qty:"2x 300 g" },
            { name:"√ìleo de Soja PET", qty:"2x 900 ml" },
            { name:"Papel Higi√™nico Folha Simples c/ 4 Rolos", qty:"1x 4x30 m" },
            { name:"Polenta Preparo R√°pido", qty:"1x 500 g" },
            { name:"Pudim em P√≥ Coco", qty:"1x 50 g" },
            { name:"Refresco em P√≥ Morango", qty:"2x 25 g" },
            { name:"Sab√£o em P√≥", qty:"1x 1 kg" },
            { name:"Sabonete Glicerinado", qty:"2x 90 g" },
            { name:"Sal Refinado Iodado", qty:"1x 1 kg" },
            { name:"Sardinha em √ìleo Lata Abre F√°cil", qty:"1x 125 g" },
        ],
        packaging:"Caixas de Papel√£o Corrugado Duplo"
    }
};

let map, userLat = -26.3726, userLng = -48.7213; // Araquari default

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPLASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
    const splash = document.getElementById('splash');

    // Spawn floating food emojis
    const foods = ['üçö','ü´ò','‚òï','ü•õ','üçù','ü´í','üçÖ','üåΩ','üç™','üßÇ','üçû','üêü','ü•´','üåæ','üç¨','ü•î','üç≥','üßà','ü•©','üçå'];
    const container = document.getElementById('splash-foods');
    for(let i = 0; i < 24; i++) {
        const el = document.createElement('div');
        el.className = 'splash-food';
        el.textContent = foods[i % foods.length];
        el.style.left = (Math.random() * 100) + '%';
        el.style.fontSize = (20 + Math.random() * 18) + 'px';
        el.style.animationDuration = (3 + Math.random() * 4) + 's';
        el.style.animationDelay = (Math.random() * 3.5) + 's';
        container.appendChild(el);
    }

    const hideSplash = () => {
        splash.classList.add('hide');
        setTimeout(() => { splash.style.display = 'none'; initMap(); }, 800);
    };

    // Auto-hide after loader bar finishes (2s delay + 2.5s fill + small buffer)
    setTimeout(hideSplash, 5000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initMap() {
    map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView([userLat, userLng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Try to get user location
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            map.setView([userLat, userLng], 16);
        }, () => {}, { enableHighAccuracy:true, timeout:5000 });
    }

    // On map move, update address
    map.on('moveend', onMapMove);
    map.on('move', () => {
        document.getElementById('center-pin').classList.remove('bounce');
    });
    map.on('moveend', () => {
        document.getElementById('center-pin').classList.add('bounce');
    });
}

function onMapMove() {
    const center = map.getCenter();
    state.lat = center.lat;
    state.lng = center.lng;
    reverseGeocode(center.lat, center.lng);
}

function reverseGeocode(lat, lng) {
    fetch(`/api/geocode?lat=${lat}&lng=${lng}`)
        .then(r => {
            if(!r.ok) throw new Error('Geocode error');
            return r.json();
        })
        .then(data => {
            const a = data.address || {};
            const road = a.road || a.pedestrian || a.footway || 'Localiza√ß√£o selecionada';
            const houseNum = a.house_number || '';
            const area = a.suburb || a.neighbourhood || a.city_district || '';
            const city = a.city || a.town || a.village || 'Araquari';
            const st = a.state || 'SC';

            const main = road;
            const sub = [area, city, st].filter(Boolean).join(', ');

            document.getElementById('map-address').textContent = houseNum ? `${main}, ${houseNum}` : main;
            document.getElementById('map-address-sub').textContent = sub || 'Mova para ajustar';

            state.addressFull = { main, sub, road, area, city, state:st, houseNum };
        })
        .catch(() => {
            document.getElementById('map-address').textContent = 'Localiza√ß√£o selecionada';
            document.getElementById('map-address-sub').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
            state.addressFull = { main:'Localiza√ß√£o selecionada', sub:`${lat.toFixed(5)}, ${lng.toFixed(5)}` };
        });
}

function centerOnUser() {
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            map.setView([userLat, userLng], 17, { animate:true });
        }, () => showToast('N\u00E3o foi poss\u00EDvel obter sua localiza\u00E7\u00E3o.', 'error'), { enableHighAccuracy:true });
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');

    const pin = document.getElementById('center-pin');
    const pinShadow = document.getElementById('center-pin-shadow');

    if(id === 'map') {
        pin.style.display = 'block';
        pinShadow.style.display = 'block';
        setTimeout(() => { map.invalidateSize(); onMapMove(); }, 100);
    } else {
        pin.style.display = 'none';
        pinShadow.style.display = 'none';
    }

    if(id === 'home') {
        exitDonationMode();
    }

    if(id === 'payment') renderPaymentSummary();
}

function goToMap() {
    showScreen('map');
}

function goBackFromDetail() {
    // Keep donation mode active when going back
    const wasDonation = state.isDonation;
    showScreen('home');
    if(wasDonation) {
        state.isDonation = true;
        document.body.classList.add('donation-mode');
        document.getElementById('donation-mode-banner').style.display = 'block';
        const btn = document.getElementById('btn-toggle-donate');
        btn.innerHTML = '<img src="assets/img/nav-cesta.png" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"> Voltar a comprar';
        btn.className = 'btn btn-sm btn-donate';
        btn.style.flex = '1'; btn.style.padding = '8px 12px'; btn.style.fontSize = '12px'; btn.style.borderRadius = '10px';
        const title = document.querySelector('#home-sheet .sheet-title');
        const sub = document.querySelector('#home-sheet .sheet-sub');
        if(title) title.innerHTML = 'Doe uma cesta \u2764\uFE0F';
        if(sub) sub.textContent = 'Escolha a cesta que deseja doar';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BASKET SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectBasket(type) {
    state.basket = type;
    state.qty = 1;
    document.querySelectorAll('.basket-card').forEach(c => c.classList.remove('selected'));
    document.getElementById('card-' + type).classList.add('selected');
    openDetail(type);
}

function openDetail(type) {
    const b = BASKETS[type];
    showScreen('detail');
    renderDetail();
}

function renderDetail() {
    const b = BASKETS[state.basket];
    const pixPrice = (b.price * 0.95).toFixed(2).replace('.',',');
    const totalPrice = (b.price * state.qty).toFixed(2).replace('.',',');

    const imgBlock = b.img ? `<div class="detail-img-wrap"><img src="${b.img}" alt="${b.name}" onclick="openLightbox('${b.img}')"></div>` : '';
    const pkgBlock = b.packaging ? `<div class="detail-packaging">Embalagem: ${b.packaging}</div>` : '';

    const donationHero = state.isDonation ? `
        <div style="background:linear-gradient(135deg,rgba(212,175,55,0.12),rgba(212,175,55,0.04));border:1px solid rgba(212,175,55,0.25);border-radius:14px;padding:16px;margin:0 20px 16px;text-align:center">
            <div style="font-size:28px;margin-bottom:6px">\u2764\uFE0F</div>
            <div style="font-size:15px;font-weight:800;color:#D4AF37">Voc\u00EA est\u00E1 doando esta cesta</div>
            <div style="font-size:12px;color:rgba(212,175,55,0.7);margin-top:6px;line-height:1.5">
                Esta cesta ser\u00E1 entregue a uma fam\u00EDlia em situa\u00E7\u00E3o de vulnerabilidade na regi\u00E3o de Araquari.
                N\u00F3s cuidamos de tudo!
            </div>
        </div>` : '';

    document.getElementById('detail-content').innerHTML = `
        <div class="detail-hero">
            <div class="detail-name">${state.isDonation ? '\u2764\uFE0F ' : ''}${b.name}</div>
            <div class="detail-desc">${b.desc}</div>
            <div class="detail-price-row">
                <div class="detail-price">R$ ${b.price.toFixed(2).replace('.',',')}</div>
                ${state.isDonation ? '' : '<div class="detail-price-pix">PIX R$ ' + pixPrice + '</div>'}
            </div>
        </div>

        ${donationHero}
        ${imgBlock}

        <div class="detail-section-label">Itens da cesta (${b.items.length})</div>

        <div class="detail-items">
            ${b.items.map(item => `
                <div class="detail-item">
                    <div class="detail-item-left">
                        <div class="detail-item-dot" ${state.isDonation ? 'style="background:#D4AF37"' : ''}></div>
                        <div class="detail-item-name">${item.name}</div>
                    </div>
                    <div class="detail-item-qty">${item.qty}</div>
                </div>
            `).join('')}
        </div>

        ${pkgBlock}
        <div style="padding:14px 20px 0;font-size:10px;color:var(--text3);line-height:1.5;font-weight:500">
            *Imagens meramente ilustrativas.<br>
            **As marcas e quantidades dos produtos podem sofrer altera\u00E7\u00F5es sem aviso pr\u00E9vio, de acordo com a disponibilidade em estoque.
        </div>
        <div style="height:80px"></div>
    `;

    document.getElementById('detail-footer').innerHTML = `
        <div class="qty-selector">
            <button class="qty-btn" onclick="changeQty(-1)">\u2212</button>
            <span class="qty-val" id="qty-display">${state.qty}</span>
            <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>
        <button class="btn ${state.isDonation ? 'btn-donate' : 'btn-primary'}" style="flex:1" onclick="proceedFromDetail()">
            ${state.isDonation ? '\u2764\uFE0F Doar' : 'Pedir'} \u00B7 R$ ${totalPrice}
        </button>
    `;
}

function changeQty(delta) {
    state.qty = Math.max(1, Math.min(10, state.qty + delta));
    renderDetail();
}

function proceedFromDetail() {
    if(state.isDonation) {
        // Show donation contact modal first
        document.getElementById('modal-donation-contact').classList.add('show');
        document.getElementById('donation-contact-fields').style.display = 'none';
        document.getElementById('donation-contact-buttons').style.display = 'block';
        document.getElementById('input-donor-name').value = '';
        document.getElementById('input-donor-phone').value = '';
    } else if(state.address) {
        showScreen('payment');
    } else {
        goToMap();
    }
}

function showDonationContactFields() {
    document.getElementById('donation-contact-buttons').style.display = 'none';
    document.getElementById('donation-contact-fields').style.display = 'block';
    document.getElementById('input-donor-name').focus();
}

function confirmDonationContact() {
    const nome = document.getElementById('input-donor-name').value.trim();
    const fone = document.getElementById('input-donor-phone').value.trim();
    if(!nome) { shakeInput('input-donor-name'); return; }
    if(fone.length < 14) { shakeInput('input-donor-phone'); return; }
    state.donorContact = { nome, telefone: fone };
    proceedToDonationPayment();
}

function skipDonationContact() {
    state.donorContact = null;
    proceedToDonationPayment();
}

function proceedToDonationPayment() {
    document.getElementById('modal-donation-contact').classList.remove('show');
    const donorInfo = state.donorContact
        ? 'DOADOR: ' + state.donorContact.nome + ' | WhatsApp: ' + state.donorContact.telefone + ' | Deseja receber info da entrega'
        : 'Doador an√¥nimo';
    state.address = {
        main: 'Doa√ß√£o - Araquari Cestas',
        sub: 'A fam√≠lia beneficiada ser√° escolhida pela equipe',
        ref: donorInfo, comp: '', num: 'S/N',
        recebedor: 'Fam√≠lia beneficiada (Araquari Cestas)',
        telefone: state.donorContact ? state.donorContact.telefone : '(47) 00000-0000'
    };
    state.addressFull = {
        road: 'Doa√ß√£o solid√°ria', main: 'Doa√ß√£o - Araquari Cestas',
        sub: 'Araquari, SC', area: 'Centro', city: 'Araquari',
        state: 'SC', houseNum: 'S/N'
    };
    state.lat = -26.3726;
    state.lng = -48.7213;
    showScreen('payment');
    renderPaymentSummary();
}

function toggleDonationMode() {
    state.isDonation = !state.isDonation;
    const body = document.body;
    const banner = document.getElementById('donation-mode-banner');
    const btn = document.getElementById('btn-toggle-donate');
    const title = document.querySelector('#home-sheet .sheet-title');
    const sub = document.querySelector('#home-sheet .sheet-sub');

    if(state.isDonation) {
        body.classList.add('donation-mode');
        banner.style.display = 'block';
        btn.innerHTML = '<img src="assets/img/nav-cesta.png" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"> Voltar a comprar';
        btn.className = 'btn btn-sm btn-donate';
        btn.style.flex = '1';
        btn.style.padding = '8px 12px';
        btn.style.fontSize = '12px';
        btn.style.borderRadius = '10px';
        if(title) title.innerHTML = 'Doe uma cesta &#x2764;&#xFE0F;';
        if(sub) sub.textContent = 'Escolha a cesta que deseja doar';
    } else {
        exitDonationMode();
    }
}

function exitDonationMode() {
    state.isDonation = false;
    state.donorContact = null;
    document.body.classList.remove('donation-mode');
    const banner = document.getElementById('donation-mode-banner');
    const btn = document.getElementById('btn-toggle-donate');
    const title = document.querySelector('#home-sheet .sheet-title');
    const sub = document.querySelector('#home-sheet .sheet-sub');
    if(banner) banner.style.display = 'none';
    if(btn) {
        btn.innerHTML = '<img src="assets/img/nav-doacao.png" style="width:16px;height:16px;vertical-align:middle;margin-right:4px"> Doar cesta';
        btn.className = 'btn btn-sm btn-donate-outline';
        btn.style.flex = '1';
        btn.style.padding = '8px 12px';
        btn.style.fontSize = '12px';
        btn.style.borderRadius = '10px';
    }
    if(title) title.innerHTML = 'Escolha sua cesta \uD83D\uDED2';
    if(sub) sub.textContent = 'Selecione o tipo e pe\u00E7a agora';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADDRESS CONFIRMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmAddress() {
    const modal = document.getElementById('modal-address');
    const af = state.addressFull || {};
    document.getElementById('modal-address-main').textContent = af.main || 'Endere√ßo selecionado';
    document.getElementById('modal-address-sub').textContent = af.sub || '';
    document.getElementById('input-recebedor').value = '';
    document.getElementById('input-telefone').value = '';
    document.getElementById('input-numero').value = af.houseNum || '';
    document.getElementById('input-ref').value = '';
    document.getElementById('input-comp').value = '';
    modal.classList.add('show');
}

function closeModal() {
    document.getElementById('modal-address').classList.remove('show');
}

function saveAddress() {
    const recebedor = document.getElementById('input-recebedor').value.trim();
    const telefone = document.getElementById('input-telefone').value.trim();
    const num = document.getElementById('input-numero').value.trim();
    const ref = document.getElementById('input-ref').value.trim();
    const comp = document.getElementById('input-comp').value.trim();

    if(!recebedor) { shakeInput('input-recebedor'); return; }
    if(telefone.length < 14) { shakeInput('input-telefone'); return; }
    if(!num) { shakeInput('input-numero'); return; }
    if(!ref) { shakeInput('input-ref'); return; }

    const af = state.addressFull || {};
    state.address = {
        main: af.main + (num ? ', ' + num : ''),
        sub: af.sub,
        ref, comp, num, recebedor, telefone
    };

    closeModal();

    // If basket already selected, go to payment
    if(state.basket) {
        setTimeout(() => showScreen('payment'), 300);
    } else {
        setTimeout(() => showScreen('home'), 300);
    }
}

function shakeInput(id) {
    const el = document.getElementById(id);
    el.style.borderColor = 'var(--red)';
    el.style.animation = 'shake 0.4s';
    el.focus();
    setTimeout(() => { el.style.animation = ''; el.style.borderColor = ''; }, 400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPaymentSummary() {
    if(!state.basket) return;

    // Update payment screen title for donation mode
    const payTitle = document.getElementById('payment-title');
    const paySub = document.getElementById('payment-sub');
    if(payTitle) payTitle.innerHTML = state.isDonation ? '\u2764\uFE0F Finalizar Doa\u00E7\u00E3o' : 'Pagamento \uD83D\uDCB3';
    if(paySub) paySub.textContent = state.isDonation ? 'Escolha como deseja pagar sua doa\u00E7\u00E3o' : 'Escolha como deseja pagar';

    const b = BASKETS[state.basket];
    const subtotal = b.price * state.qty;
    const isPix = state.payMethod === 'pix';
    const discount = isPix ? subtotal * 0.05 : 0;
    const total = subtotal - discount;

    const donationBadge = state.isDonation ? `<div style="background:rgba(61,163,61,0.12);border:1px solid rgba(61,163,61,0.3);border-radius:10px;padding:10px 14px;margin-bottom:12px;text-align:center">
        <div style="font-size:14px;font-weight:800;color:var(--green)">&#x2764;&#xFE0F; Voc\u00EA est\u00E1 fazendo uma doa\u00E7\u00E3o!</div>
        <div style="font-size:11px;color:var(--text2);margin-top:4px">N\u00F3s encontraremos uma fam\u00EDlia que precisa na regi\u00E3o de Araquari</div>
    </div>` : '';

    const addressBlock = state.isDonation ? `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">DESTINO DA DOA\u00C7\u00C3O</div>
            <div style="font-size:13px;font-weight:700;color:var(--green)">Fam\u00EDlia beneficiada em Araquari</div>
            <div style="font-size:11px;color:var(--text2);margin-top:4px">A equipe Araquari Cestas ir\u00E1 selecionar e entregar a cesta para quem mais precisa</div>
            ${state.donorContact ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
                <div style="font-size:11px;color:var(--text3);margin-bottom:2px">SEUS DADOS PARA ACOMPANHAMENTO</div>
                <div style="font-size:13px;font-weight:700">${state.donorContact.nome}</div>
                <div style="font-size:11px;color:var(--text2)">${state.donorContact.telefone}</div>
                <div style="font-size:10px;color:var(--green);margin-top:4px">\u2705 Voc\u00EA ser\u00E1 notificado quando a cesta for entregue</div>
            </div>` : ''}
        </div>` : (state.address ? `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">ENTREGAR EM</div>
            <div style="font-size:13px;font-weight:700">${state.address.main}</div>
            <div style="font-size:11px;color:var(--text3)">${state.address.sub}</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Ref: ${state.address.ref}</div>
            <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
                <div style="font-size:11px;color:var(--text3);margin-bottom:2px">RECEBEDOR</div>
                <div style="font-size:13px;font-weight:700">${state.address.recebedor}</div>
                <div style="font-size:11px;color:var(--text2)">${state.address.telefone}</div>
            </div>
        </div>` : '');

    document.getElementById('payment-summary').innerHTML = `
        ${donationBadge}
        <div class="summary-row"><span>${b.emoji} ${b.name} \u00D7 ${state.qty}</span><span>R$ ${subtotal.toFixed(2).replace('.',',')}</span></div>
        <div class="summary-row"><span>${state.isDonation ? '\u2764\uFE0F Doa\u00E7\u00E3o' : '\uD83D\uDE9A Entrega'}</span><span style="color:var(--green)">Gr\u00E1tis</span></div>
        ${isPix ? `<div class="summary-row"><span>\uD83D\uDCF1 Desconto PIX</span><span class="discount">-R$ ${discount.toFixed(2).replace('.',',')}</span></div>` : ''}
        <div class="summary-row summary-total"><span style="font-weight:800;color:var(--text)">Total</span><span>R$ ${total.toFixed(2).replace('.',',')}</span></div>
        ${addressBlock}
    `;
}

function selectPay(method) {
    // Check minimum for boleto (Mercado Pago requires >= R$5)
    if((method === 'boleto' || method === 'boleto30') && state.basket) {
        const total = BASKETS[state.basket].price * state.qty;
        if(total < 5) {
            showToast('Valor m00EDnimo para boleto 00E9 R$ 5,00. Escolha PIX ou cart00E3o.', 'warning');
            return;
        }
    }
    state.payMethod = method;
    document.querySelectorAll('.pay-method').forEach(m => m.classList.remove('selected'));
    document.getElementById('pay-' + method).classList.add('selected');

    document.getElementById('boleto30-area').style.display = method === 'boleto30' ? 'block' : 'none';
    document.getElementById('boleto-cpf-area').style.display = method === 'boleto' ? 'block' : 'none';
    document.getElementById('btn-pay').disabled = false;

    if(method === 'boleto30') {
        document.getElementById('btn-pay').textContent = 'üì© Enviar para An√°lise';
    } else if(state.isDonation) {
        document.getElementById('btn-pay').textContent = '\u2764\uFE0F Finalizar Doa\u00E7\u00E3o';
        document.getElementById('btn-pay').className = 'btn btn-donate';
    } else {
        document.getElementById('btn-pay').textContent = 'Finalizar Pedido';
        document.getElementById('btn-pay').className = 'btn btn-primary';
    }

    renderPaymentSummary();
}

function handleUpload(type, el) {
    if(el.files && el.files[0]) {
        state.uploads[type] = true;
        state.uploadFiles[type] = el.files[0];
        const container = el.closest('.file-upload');
        container.classList.add('done');
        container.innerHTML = `<input type="file" style="display:none"><div class="file-ok">‚úÖ ${el.files[0].name}</div>`;
    }
}

async function finalizePay() {
    if(!state.payMethod) return;
    if(!state.address) { showToast('Defina o endere00E7o de entrega primeiro.', 'warning'); return; }

    const btn = document.getElementById('btn-pay');
    const originalText = btn.textContent;

    if(state.payMethod === 'boleto30') {
        const cpf = document.getElementById('input-cpf')?.value || '';
        if(cpf.length < 14) { showToast('Preencha o CPF corretamente.', 'warning'); return; }
        if(!state.uploads.doc || !state.uploads.res) {
            showToast('Envie todos os documentos obrigat00F3rios.', 'warning'); return;
        }
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.textContent = 'Enviando pedido...';

    try {
        const b = BASKETS[state.basket];
        const subtotal = b.price * state.qty;
        const isPix = state.payMethod === 'pix';
        const discount = isPix ? subtotal * 0.05 : 0;
        const total = subtotal - discount;

        const af = state.addressFull || {};
        const addr = state.address || {};

        const body = {
            cesta_tipo: state.basket,
            cesta_nome: b.name,
            cesta_preco: b.price,
            quantidade: state.qty,
            endereco_rua: af.road || af.main || '',
            endereco_numero: addr.num || '',
            endereco_complemento: addr.comp || '',
            endereco_referencia: addr.ref || '',
            endereco_bairro: af.area || '',
            endereco_cidade: af.city || 'Araquari',
            endereco_estado: abreviarEstado(af.state || 'SC'),
            latitude: state.lat || -26.3726,
            longitude: state.lng || -48.7213,
            recebedor_nome: addr.recebedor || '',
            recebedor_telefone: addr.telefone || '',
            pagamento_metodo: state.payMethod,
            desconto: discount,
            total: total,
            cpf: state.payMethod === 'boleto30' ? (document.getElementById('input-cpf')?.value || '') : null
        };

        console.log('Enviando pedido:', JSON.stringify(body));

        const res = await fetch('/api/pedidos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log('Resposta:', data);

        if(!res.ok || !data.success) {
            throw new Error(data.detail || data.error || 'Erro ao criar pedido');
        }

        state.pedidoCodigo = data.pedido.codigo;

        // Upload documents for boleto30
        if(state.payMethod === 'boleto30' && (state.uploadFiles.doc || state.uploadFiles.res)) {
            btn.textContent = 'Enviando documentos...';
            const formData = new FormData();
            if(state.uploadFiles.doc) formData.append('doc_identidade', state.uploadFiles.doc);
            if(state.uploadFiles.res) formData.append('doc_residencia', state.uploadFiles.res);

            await fetch('/api/pedidos/' + data.pedido.codigo + '/documentos', {
                method: 'POST',
                body: formData
            });
        }

        // Process payment based on method
        btn.textContent = 'Processando pagamento...';

        if(state.payMethod === 'boleto30') {
            showStatus('analise');
        } else if(state.payMethod === 'pix') {
            await processPixPayment(data.pedido.codigo);
        } else if(state.payMethod === 'boleto') {
            await processBoletoPayment(data.pedido.codigo);
        } else if(state.payMethod === 'cartao') {
            showCardForm(data.pedido.codigo);
        } else {
            showStatus('separacao');
        }

    } catch(err) {
        console.error('Erro ao finalizar pedido:', err);
        showToast('Erro ao enviar pedido: ' + err.message, 'error', 5000);
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENT PROCESSING (Mercado Pago)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pixPollInterval = null;

async function processPixPayment(codigo) {
    showScreen('status');
    const el = document.getElementById('status-content');
    el.innerHTML = `
        <div class="status-icon"><img src="assets/img/pay-pix.png" style="width:64px;height:64px"></div>
        <div class="status-title">Pagamento PIX</div>
        <div class="status-sub">Gerando QR Code...</div>
        <div style="text-align:center"><div class="spin" style="margin:20px auto"></div></div>
    `;

    try {
        const res = await fetch('/api/pagamento/pix/' + codigo, { method: 'POST' });
        const data = await res.json();

        if(!res.ok || !data.success) throw new Error(data.error || 'Erro ao gerar PIX');

        el.innerHTML = `
            <div style="margin-bottom:8px"><img src="assets/img/pay-pix.png" style="width:48px;height:48px"></div>
            <div class="status-title">Pague com PIX</div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:4px;text-align:center">Escaneie o QR Code ou copie o c√≥digo</div>
            <div class="pix-box">
                <div class="pix-qr">
                    <img src="data:image/png;base64,${data.qrcodeBase64 || ''}" alt="QR Code PIX" onerror="this.parentElement.innerHTML='<div style=color:var(--text3);font-size:13px>QR Code indispon√≠vel.<br>Use o c√≥digo abaixo.</div>'">
                </div>
                <div class="pix-code" id="pix-code-text">${data.qrcode || data.qr_code || ''}</div>
                <button class="pix-copy-btn" onclick="copyPixCode()">üìã Copiar c√≥digo PIX</button>
            </div>
            <div class="payment-waiting" id="pix-waiting">
                <div class="spin-sm"></div> Aguardando pagamento...
            </div>
            <div style="font-size:11px;color:var(--text3);text-align:center;margin-top:8px">
                O pedido sera confirmado automaticamente apos o pagamento
            </div>
            <div style="background:var(--card);border-radius:12px;padding:10px 14px;margin:16px auto;max-width:280px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
                <div style="font-size:16px;font-weight:900;color:var(--green);margin-top:4px">${codigo}</div>
            </div>
            <button class="btn btn-dark" onclick="showStatus('separacao')" style="max-width:300px;margin-top:8px">J√° paguei ‚Äî ver status do pedido ‚ñ∏</button>
        `;

        // Poll for payment confirmation
        startPixPolling(codigo);

    } catch(err) {
        console.error('Erro PIX:', err);
        el.innerHTML = `
            <div class="status-icon">‚ö†Ô∏è</div>
            <div class="status-title">Erro no PIX</div>
            <div class="status-sub">${err.message}</div>
            <div style="background:var(--card);border-radius:12px;padding:10px 14px;margin:16px auto;max-width:280px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
                <div style="font-size:16px;font-weight:900;color:var(--orange);margin-top:4px">${codigo}</div>
            </div>
            <div class="status-sub" style="font-size:12px">Seu pedido foi criado. Voc√™ pode pagar depois acessando "Meus Pedidos".</div>
            <button class="btn btn-dark" onclick="showStatus('separacao')" style="max-width:300px">Ver status do pedido</button>
        `;
    }
}

function copyPixCode() {
    const code = document.getElementById('pix-code-text')?.textContent || '';
    if(!code) return;
    navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('.pix-copy-btn');
        if(btn) { btn.textContent = '‚úÖ C√≥digo copiado!'; setTimeout(() => btn.textContent = 'üìã Copiar c√≥digo PIX', 2000); }
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = code; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        const btn = document.querySelector('.pix-copy-btn');
        if(btn) { btn.textContent = '‚úÖ C√≥digo copiado!'; setTimeout(() => btn.textContent = 'üìã Copiar c√≥digo PIX', 2000); }
    });
}

function startPixPolling(codigo) {
    if(pixPollInterval) clearInterval(pixPollInterval);
    let attempts = 0;
    pixPollInterval = setInterval(async () => {
        attempts++;
        if(attempts > 120) { clearInterval(pixPollInterval); return; } // Stop after 10min
        try {
            const res = await fetch('/api/pagamento/status/' + codigo);
            if(!res.ok) return;
            const data = await res.json();
            if(data.pagamentoAprovado || data.status === 'approved') {
                clearInterval(pixPollInterval);
                const waiting = document.getElementById('pix-waiting');
                if(waiting) waiting.innerHTML = '<span style="color:var(--green);font-weight:800">‚úÖ Pagamento confirmado!</span>';
                setTimeout(() => showStatus('separacao'), 1500);
            }
        } catch(e) {}
    }, 5000);
}

async function processBoletoPayment(codigo) {
    // Get CPF
    const cpfEl = document.getElementById('input-cpf-boleto');
    const cpf = cpfEl ? cpfEl.value.replace(/\D/g, '') : '';
    if(cpf.length !== 11) {
        showToast('Informe um CPF v00E1lido para gerar o boleto.', 'warning');
        shakeInput('input-cpf-boleto');
        return;
    }

    showScreen('status');
    const el = document.getElementById('status-content');
    el.innerHTML = `
        <div class="status-icon"><img src="assets/img/pay-boleto.png" style="width:64px;height:64px"></div>
        <div class="status-title">Gerando Boleto</div>
        <div class="status-sub">Aguarde...</div>
        <div style="text-align:center"><div class="spin" style="margin:20px auto"></div></div>
    `;

    try {
        const res = await fetch('/api/pagamento/boleto/' + codigo, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dias: 3, cpf: cpf })
        });
        const data = await res.json();

        if(!res.ok || !data.success) throw new Error(data.error || 'Erro ao gerar boleto');

        el.innerHTML = `
            <div style="margin-bottom:8px"><img src="assets/img/pay-boleto.png" style="width:48px;height:48px"></div>
            <div class="status-title">Boleto Gerado!</div>
            <div style="font-size:13px;color:var(--text2);margin-bottom:4px;text-align:center">Vencimento: ${data.vencimento || '3 dias uteis'}</div>
            <div class="boleto-box">
                ${data.boletoBarcode ? `<div class="boleto-barcode">${data.boletoBarcode}</div>` : ''}
                ${data.boletoUrl ? `<a href="${data.boletoUrl}" target="_blank" class="boleto-link-btn">üìÑ Abrir Boleto</a>` : ''}
                ${data.boletoPdf ? `<a href="${data.boletoPdf}" target="_blank" class="boleto-link-btn" style="margin-top:8px;background:var(--green)">üì• Baixar PDF</a>` : ''}
                ${data.boletoBarcode ? `<button class="pix-copy-btn" style="background:var(--orange)" onclick="navigator.clipboard.writeText('${data.boletoBarcode}');this.textContent='‚úÖ Copiado!';setTimeout(()=>this.textContent='üìã Copiar c√≥digo de barras',2000)">üìã Copiar c√≥digo de barras</button>` : ''}
            </div>
            <div style="background:var(--card);border-radius:12px;padding:10px 14px;margin:16px auto;max-width:280px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
                <div style="font-size:16px;font-weight:900;color:var(--green);margin-top:4px">${codigo}</div>
            </div>
            <button class="btn btn-dark" onclick="showStatus('separacao')" style="max-width:300px;margin-top:8px">Ver status do pedido ‚ñ∏</button>
        `;

    } catch(err) {
        console.error('Erro Boleto:', err);
        el.innerHTML = `
            <div class="status-icon">‚ö†Ô∏è</div>
            <div class="status-title">Erro no Boleto</div>
            <div class="status-sub">${err.message}</div>
            <div style="background:var(--card);border-radius:12px;padding:10px 14px;margin:16px auto;max-width:280px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
                <div style="font-size:16px;font-weight:900;color:var(--orange);margin-top:4px">${codigo}</div>
            </div>
            <button class="btn btn-dark" onclick="showStatus('separacao')" style="max-width:300px">Ver status do pedido</button>
        `;
    }
}

function showCardForm(codigo) {
    showScreen('status');
    const el = document.getElementById('status-content');
    const b = BASKETS[state.basket];
    const total = (b.price * state.qty).toFixed(2).replace('.',',');

    el.innerHTML = `
        <div style="margin-bottom:8px"><img src="assets/img/pay-cartao.png" style="width:48px;height:48px"></div>
        <div class="status-title">Cart√£o de Cr√©dito</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:4px;text-align:center">Total: R$ ${total}</div>
        <div class="card-form-box">
            <input class="card-input" id="card-number" placeholder="N√∫mero do cart√£o" maxlength="19" oninput="this.value=this.value.replace(/[^0-9]/g,'').replace(/(.{4})/g,'$1 ').trim()">
            <input class="card-input" id="card-name" placeholder="Nome no cart√£o" style="text-transform:uppercase">
            <div class="card-row">
                <input class="card-input" id="card-expiry" placeholder="MM/AA" maxlength="5" oninput="let v=this.value.replace(/[^0-9]/g,'');if(v.length>=2)v=v.slice(0,2)+'/'+v.slice(2);this.value=v">
                <input class="card-input" id="card-cvv" placeholder="CVV" maxlength="4" type="password">
            </div>
            <select class="card-input" id="card-parcelas" style="color:var(--text)">
                <option value="1">1x de R$ ${total} (sem juros)</option>
                <option value="2">2x de R$ ${(b.price * state.qty / 2).toFixed(2).replace('.',',')} (sem juros)</option>
                <option value="3">3x de R$ ${(b.price * state.qty / 3).toFixed(2).replace('.',',')} (sem juros)</option>
            </select>
            <input class="card-input" id="card-email" placeholder="E-mail do titular" type="email">
            <button class="card-pay-btn" id="card-submit-btn" onclick="processCardPayment('${codigo}')">Pagar R$ ${total}</button>
        </div>
        <div id="card-status" style="text-align:center;margin-top:12px"></div>
        <div style="background:var(--card);border-radius:12px;padding:10px 14px;margin:16px auto;max-width:280px;text-align:center">
            <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
            <div style="font-size:16px;font-weight:900;color:var(--green);margin-top:4px">${codigo}</div>
        </div>
    `;
}

async function processCardPayment(codigo) {
    const btn = document.getElementById('card-submit-btn');
    const statusEl = document.getElementById('card-status');
    btn.disabled = true;
    btn.textContent = 'Processando...';
    statusEl.innerHTML = '<div class="payment-waiting"><div class="spin-sm"></div> Processando pagamento...</div>';

    try {
        // Get MP public key
        const keyRes = await fetch('/api/pagamento/public-key');
        const keyData = await keyRes.json();
        const mp = new MercadoPago(keyData.publicKey || keyData.public_key);

        const cardNumber = document.getElementById('card-number').value.replace(/\s/g,'');
        const expiry = document.getElementById('card-expiry').value.split('/');
        const cardName = document.getElementById('card-name').value;
        const cvv = document.getElementById('card-cvv').value;
        const email = document.getElementById('card-email').value;
        const parcelas = parseInt(document.getElementById('card-parcelas').value) || 1;

        if(!cardNumber || !cardName || expiry.length !== 2 || !cvv || !email) {
            throw new Error('Preencha todos os campos do cart√£o');
        }

        // Create card token via MP SDK
        const cardToken = await mp.createCardToken({
            cardNumber: cardNumber,
            cardholderName: cardName,
            cardExpirationMonth: expiry[0],
            cardExpirationYear: '20' + expiry[1],
            securityCode: cvv,
            identificationType: 'CPF',
            identificationNumber: '00000000000'
        });

        if(!cardToken || !cardToken.id) throw new Error('Erro ao tokenizar cartao');

        // Send to backend
        const res = await fetch('/api/pagamento/cartao/' + codigo, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: cardToken.id, parcelas, email })
        });
        const data = await res.json();

        if(!res.ok || !data.success) throw new Error(data.error || 'Pagamento recusado');

        statusEl.innerHTML = '<div style="color:var(--green);font-weight:800;font-size:16px">‚úÖ Pagamento aprovado!</div>';
        setTimeout(() => showStatus('separacao'), 1500);

    } catch(err) {
        console.error('Erro cartao:', err);
        statusEl.innerHTML = `<div style="color:var(--red);font-weight:700;font-size:13px">‚ùå ${err.message}</div>`;
        btn.disabled = false;
        btn.textContent = 'Tentar novamente';
    }
}
function showStatus(type) {
    showScreen('status');
    const b = BASKETS[state.basket];
    const codigo = state.pedidoCodigo || '---';
    const el = document.getElementById('status-content');

    if(type === 'analise') {
        el.innerHTML = `
            <div class="status-icon"><img src="assets/img/status-aguardando.png" style="width:64px;height:64px"></div>
            <div class="status-title">Em An\u00E1lise</div>
            <div style="background:var(--card);border-radius:12px;padding:12px 16px;margin:12px auto;max-width:280px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
                <div style="font-size:18px;font-weight:900;color:var(--orange);margin-top:4px;letter-spacing:1px">${codigo}</div>
            </div>
            <div class="status-sub">Seus documentos foram enviados e est√£o sendo analisados. Voc√™ receber√° uma notifica√ß√£o assim que for aprovado.</div>
            <div class="status-steps">
                <div class="status-step done"><div class="step-dot"><img src="assets/img/status-confirmado.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Pedido recebido</div><div class="step-desc">Agora mesmo</div></div></div>
                <div class="status-step done"><div class="step-dot"><img src="assets/img/status-confirmado.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Documentos enviados</div><div class="step-desc">2 documentos recebidos</div></div></div>
                <div class="status-step active"><div class="step-dot"><img src="assets/img/status-aguardando.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Em an√°lise de cr√©dito</div><div class="step-desc">Prazo: at√© 24h √∫teis</div></div></div>
                <div class="status-step"><div class="step-dot"><img src="assets/img/status-aguardando.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Aguardando aprova√ß√£o</div><div class="step-desc">Notificaremos por WhatsApp</div></div></div>
            </div>
            <a href="https://play.google.com/store/apps/details?id=com.conversemaria.app&pcampaignid=web_share" target="_blank" style="display:block;max-width:340px;margin:20px auto 16px;text-decoration:none;background:linear-gradient(135deg,#1a1a4e,#2d1b69);border:1px solid #3d2d7a;border-radius:16px;padding:16px 18px;text-align:center;transition:transform .2s;box-shadow:0 4px 20px rgba(45,27,105,.3)" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size:28px;margin-bottom:6px">üôè‚ú®</div>
                <div style="font-size:13px;color:#c9b8ff;font-weight:700;margin-bottom:4px">Enquanto espera seu alimento...</div>
                <div style="font-size:15px;color:#fff;font-weight:800;margin-bottom:4px">Receba uma b√™n√ß√£o de Maria, M√£e de Jesus</div>
                <div style="font-size:11px;color:#a594d6">Baixe gr√°tis o app Converse com Maria</div>
                <div style="margin-top:10px;display:inline-block;background:#3DA33D;color:#fff;padding:6px 18px;border-radius:8px;font-size:12px;font-weight:800">Baixar no Google Play ‚ñ∏</div>
            </a>
            <button class="btn btn-dark" onclick="showScreen('home')" style="max-width:300px">‚Üê Voltar ao in√≠cio</button>
        `;
        // Poll for status updates
        startStatusPolling(codigo);
    } else if(state.isDonation) {
        const dataHora = new Date().toLocaleString('pt-BR');
        el.innerHTML = `
            <div style="font-size:60px;margin-bottom:12px">&#x2764;&#xFE0F;</div>
            <div class="status-title" style="color:var(--green)">Doa\u00E7\u00E3o Registrada!</div>
            <div class="status-sub">Obrigado pelo seu gesto de solidariedade. A equipe Araquari Cestas ir\u00E1 encontrar uma fam\u00EDlia que precisa e entregar a cesta em seu nome.</div>

            <div style="background:var(--card);border:2px solid var(--green);border-radius:16px;padding:24px 20px;margin:16px auto;max-width:340px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:2px;margin-bottom:12px">Comprovante de Doa\u00E7\u00E3o</div>
                <div style="width:60px;height:2px;background:var(--green);margin:0 auto 12px"></div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">C\u00F3digo</div>
                <div style="font-size:18px;font-weight:900;color:var(--green);letter-spacing:1px;margin-bottom:12px">${codigo}</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Cesta doada</div>
                <div style="font-size:15px;font-weight:800;margin-bottom:12px">${b.name}</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Valor</div>
                <div style="font-size:15px;font-weight:800;color:var(--green);margin-bottom:12px">R$ ${(b.price * state.qty).toFixed(2).replace('.',',')}</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Data e hora</div>
                <div style="font-size:13px;font-weight:700;margin-bottom:12px">${dataHora}</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Destino</div>
                <div style="font-size:13px;font-weight:700">Fam\u00EDlia beneficiada - Araquari/SC</div>
                <div style="width:60px;height:2px;background:var(--green);margin:16px auto 8px"></div>
                <div style="font-size:10px;color:var(--text3);line-height:1.5">Araquari Cestas<br>Solidariedade que alimenta</div>
            </div>

            <div style="font-size:12px;color:var(--text3);text-align:center;max-width:300px;margin:12px auto;line-height:1.6">
                ${state.donorContact
                    ? 'Voc\u00EA ser\u00E1 notificado pelo WhatsApp (' + state.donorContact.telefone + ') assim que a cesta for entregue \u00E0 fam\u00EDlia beneficiada.'
                    : 'Fa\u00E7a uma captura de tela deste comprovante para seus registros. A fam\u00EDlia beneficiada ser\u00E1 escolhida e notificada pela nossa equipe.'}
            </div>

            <a href="https://play.google.com/store/apps/details?id=com.conversemaria.app&pcampaignid=web_share" target="_blank" style="display:block;max-width:340px;margin:20px auto 16px;text-decoration:none;background:linear-gradient(135deg,#1a1a4e,#2d1b69);border:1px solid #3d2d7a;border-radius:16px;padding:16px 18px;text-align:center;transition:transform .2s;box-shadow:0 4px 20px rgba(45,27,105,.3)" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size:28px;margin-bottom:6px">\uD83D\uDE4F\u2728</div>
                <div style="font-size:13px;color:#c9b8ff;font-weight:700;margin-bottom:4px">Um gesto lindo merece uma b\u00EAn\u00E7\u00E3o...</div>
                <div style="font-size:15px;color:#fff;font-weight:800;margin-bottom:4px">Converse com Maria, M\u00E3e de Jesus</div>
                <div style="font-size:11px;color:#a594d6">Baixe gr\u00E1tis o app Converse com Maria</div>
                <div style="margin-top:10px;display:inline-block;background:#3DA33D;color:#fff;padding:6px 18px;border-radius:8px;font-size:12px;font-weight:800">Baixar no Google Play \u25B8</div>
            </a>
            <button class="btn btn-dark" onclick="showScreen('home')" style="max-width:300px">\u2190 Voltar ao in\u00EDcio</button>
        `;
    } else {
        el.innerHTML = `
            <div class="status-icon"><img src="assets/img/status-pronto.png" style="width:64px;height:64px"></div>
            <div class="status-title">Pedido Criado!</div>
            <div style="background:var(--card);border-radius:12px;padding:12px 16px;margin:12px auto;max-width:280px;text-align:center">
                <div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">C√≥digo do Pedido</div>
                <div style="font-size:18px;font-weight:900;color:var(--green);margin-top:4px;letter-spacing:1px">${codigo}</div>
            </div>
            <div class="status-sub">Sua ${b.name} foi registrada! Acompanhe o status abaixo.</div>
            <div class="status-steps" id="live-steps">
                <div class="status-step done"><div class="step-dot"><img src="assets/img/status-confirmado.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Pedido confirmado</div><div class="step-desc">Pagamento registrado</div></div></div>
                <div class="status-step active"><div class="step-dot"><img src="assets/img/status-aguardando.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Aguardando confirma√ß√£o</div><div class="step-desc">Verificando pagamento</div></div></div>
                <div class="status-step"><div class="step-dot"><img src="assets/img/status-separacao.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Em separa√ß√£o</div><div class="step-desc">Montando sua cesta</div></div></div>
                <div class="status-step"><div class="step-dot"><img src="assets/img/status-pronto.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Pronto para entrega</div><div class="step-desc">Aguardando entregador</div></div></div>
                <div class="status-step"><div class="step-dot"><img src="assets/img/status-caminho.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">A caminho</div><div class="step-desc">Entregador saiu</div></div></div>
                <div class="status-step"><div class="step-dot"><img src="assets/img/status-entregue.png" style="width:28px;height:28px"></div><div class="step-text"><div class="step-title">Entregue</div><div class="step-desc">Bom apetite!</div></div></div>
            </div>
            <a href="https://play.google.com/store/apps/details?id=com.conversemaria.app&pcampaignid=web_share" target="_blank" style="display:block;max-width:340px;margin:20px auto 16px;text-decoration:none;background:linear-gradient(135deg,#1a1a4e,#2d1b69);border:1px solid #3d2d7a;border-radius:16px;padding:16px 18px;text-align:center;transition:transform .2s;box-shadow:0 4px 20px rgba(45,27,105,.3)" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size:28px;margin-bottom:6px">üôè‚ú®</div>
                <div style="font-size:13px;color:#c9b8ff;font-weight:700;margin-bottom:4px">Enquanto espera seu alimento...</div>
                <div style="font-size:15px;color:#fff;font-weight:800;margin-bottom:4px">Receba uma b√™n√ß√£o de Maria, M√£e de Jesus</div>
                <div style="font-size:11px;color:#a594d6">Baixe gr√°tis o app Converse com Maria</div>
                <div style="margin-top:10px;display:inline-block;background:#3DA33D;color:#fff;padding:6px 18px;border-radius:8px;font-size:12px;font-weight:800">Baixar no Google Play ‚ñ∏</div>
            </a>
            <button class="btn btn-dark" onclick="showScreen('home')" style="max-width:300px">‚Üê Voltar ao in√≠cio</button>
        `;
        // Poll for status updates
        startStatusPolling(codigo);
    }
}

// Map status from API to step index
const STATUS_MAP = {
    'novo': 1,
    'confirmado': 2,
    'separacao': 2,
    'pronto': 3,
    'a_caminho': 4,
    'entregue': 5
};

let pollInterval = null;

function startStatusPolling(codigo) {
    if(pollInterval) clearInterval(pollInterval);
    if(!codigo || codigo === '---') return;

    pollInterval = setInterval(async () => {
        try {
            const res = await fetch('/api/pedidos/' + codigo);
            if(!res.ok) return;
            const data = await res.json();
            const pedido = data.pedido;

            // Update live steps for normal orders
            const steps = document.querySelectorAll('#live-steps .status-step');
            if(steps.length === 0) return;

            const targetStep = STATUS_MAP[pedido.status] || 1;

            steps.forEach((step, i) => {
                step.classList.remove('done', 'active');
                if(i < targetStep) {
                    step.classList.add('done');
                    step.querySelector('.step-dot').innerHTML = '<img src="assets/img/status-confirmado.png" style="width:28px;height:28px">';
                } else if(i === targetStep) {
                    step.classList.add('active');
                }
            });

            // Update title
            const titles = { 'novo':'Pedido Criado!', 'confirmado':'Confirmado!', 'separacao':'Em Separa\u00E7\u00E3o!', 'pronto':'Pronto p/ Entrega!', 'a_caminho':'A Caminho!', 'entregue':'Entregue!' };
            const iconImgs = { 'novo':'status-pronto', 'confirmado':'status-confirmado', 'separacao':'status-separacao', 'pronto':'status-pronto', 'a_caminho':'status-caminho', 'entregue':'status-entregue' };
            const titleEl = document.querySelector('#status-content .status-title');
            const iconEl = document.querySelector('#status-content .status-icon');
            if(titleEl) titleEl.textContent = titles[pedido.status] || pedido.status;
            if(iconEl) iconEl.innerHTML = '<img src="assets/img/' + (iconImgs[pedido.status] || 'status-pronto') + '.png" style="width:64px;height:64px">';

            // Stop polling when delivered or cancelled
            if(pedido.status === 'entregue' || pedido.status === 'cancelado') {
                clearInterval(pollInterval);
            }
        } catch(e) {
            // Silent fail on poll
        }
    }, 10000); // Poll every 10 seconds
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIGHTBOX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('show');
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPARE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCompare() {
    const keys = ['x','confort','plus'];
    const baskets = keys.map(k => BASKETS[k]);

    // Collect all unique item names across all baskets
    const allItems = [];
    const seen = new Set();
    keys.forEach(k => {
        BASKETS[k].items.forEach(item => {
            if(!seen.has(item.name)) {
                seen.add(item.name);
                allItems.push(item.name);
            }
        });
    });

    // Build lookup: basket key -> item name -> qty
    const lookup = {};
    keys.forEach(k => {
        lookup[k] = {};
        BASKETS[k].items.forEach(item => { lookup[k][item.name] = item.qty; });
    });

    const colClasses = ['col-x','col-c','col-p'];

    let html = `<thead><tr>
        <th>Item</th>
        ${baskets.map((b,i) => `<th><span style="display:block;font-size:18px;margin-bottom:2px">${b.emoji}</span>${b.name}</th>`).join('')}
    </tr></thead><tbody>`;

    allItems.forEach(name => {
        html += `<tr>`;
        html += `<td>${name}</td>`;
        keys.forEach((k,i) => {
            const qty = lookup[k][name];
            if(qty) {
                html += `<td class="has-item ${colClasses[i]}">${qty}</td>`;
            } else {
                html += `<td class="no-item">‚Äî</td>`;
            }
        });
        html += `</tr>`;
    });

    // Packaging row
    html += `<tr><td>Embalagem</td>`;
    keys.forEach((k,i) => { html += `<td class="has-item" style="font-size:11px">${BASKETS[k].packaging}</td>`; });
    html += `</tr>`;

    // Price row
    html += `<tr class="compare-price-row"><td style="font-weight:900;color:var(--text)">Pre√ßo</td>`;
    keys.forEach((k,i) => {
        html += `<td class="${colClasses[i]}">R$ ${BASKETS[k].price.toFixed(2).replace('.',',')}</td>`;
    });
    html += `</tr>`;

    html += `</tbody>`;
    html += `<tfoot><tr><td colspan="4" style="text-align:center;padding:12px;font-size:10px;color:var(--text3);font-weight:500">*Imagens ilustrativas. Marcas e valores podem sofrer altera√ß√µes conforme disponibilidade.</td></tr></tfoot>`;

    document.getElementById('compare-table-body').innerHTML = html;
    document.getElementById('modal-compare').classList.add('show');
}

function closeCompare() {
    document.getElementById('modal-compare').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ORDERS SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buscarPedidos() {
    const input = document.getElementById('input-busca-pedido').value.trim();
    if(!input) return;

    const listEl = document.getElementById('orders-list');
    listEl.innerHTML = '<div style="padding:30px;color:var(--text3)">Buscando...</div>';

    try {
        let pedidos = [];

        // Check if it looks like an order code (starts with AC-)
        if(input.toUpperCase().startsWith('AC-')) {
            const res = await fetch('/api/pedidos/' + input.toUpperCase());
            if(res.ok) {
                const data = await res.json();
                pedidos = [data.pedido];
            }
        } else {
            // Search by phone
            const tel = input.replace(/\D/g, '');
            const res = await fetch('/api/pedidos/telefone/' + tel);
            if(res.ok) {
                const data = await res.json();
                pedidos = data.pedidos || [];
            }
        }

        if(pedidos.length === 0) {
            listEl.innerHTML = `
                <div style="text-align:center;padding:30px;color:var(--text3)">
                    <div style="font-size:40px;margin-bottom:8px">üîç</div>
                    <p style="font-weight:600">Nenhum pedido encontrado</p>
                    <p style="font-size:12px;margin-top:4px">Verifique o c√≥digo ou telefone digitado</p>
                </div>`;
            return;
        }

        const statusLabels = {
            'novo':'Novo', 'confirmado':'Confirmado', 'separacao':'Em Separa√ß√£o',
            'pronto':'Pronto', 'a_caminho':'A Caminho', 'entregue':'Entregue',
            'cancelado':'Cancelado', 'analise':'Em An√°lise', 'aprovado':'Aprovado', 'recusado':'Recusado'
        };
        const statusColors = {
            'novo':'var(--orange)', 'confirmado':'var(--green)', 'separacao':'var(--orange)',
            'pronto':'var(--green)', 'a_caminho':'var(--orange)', 'entregue':'var(--green)',
            'cancelado':'var(--red)', 'analise':'var(--yellow)', 'aprovado':'var(--green)', 'recusado':'var(--red)'
        };

        listEl.innerHTML = pedidos.map(p => `
            <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;text-align:left">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <span style="font-weight:900;font-size:13px;color:var(--text);letter-spacing:0.5px">${p.codigo}</span>
                    <span style="font-size:11px;font-weight:700;color:${statusColors[p.status] || 'var(--text3)'};background:${statusColors[p.status] || 'var(--text3)'}15;padding:3px 10px;border-radius:20px">${statusLabels[p.status] || p.status}</span>
                </div>
                <div style="font-size:13px;font-weight:600;color:var(--text2)">${p.cesta_nome || ''}</div>
                <div style="display:flex;justify-content:space-between;margin-top:6px">
                    <span style="font-size:12px;color:var(--text3)">${new Date(p.criado_em).toLocaleDateString('pt-BR')} ${new Date(p.criado_em).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
                    <span style="font-size:14px;font-weight:800;color:var(--green)">R$ ${parseFloat(p.total).toFixed(2).replace('.',',')}</span>
                </div>
            </div>
        `).join('');

    } catch(err) {
        listEl.innerHTML = '<div style="padding:30px;color:var(--red)">Erro ao buscar pedidos</div>';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const maskCPF = v => v.replace(/\D/g,"").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2").slice(0,14);
const maskPhone = v => v.replace(/\D/g,"").replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2").slice(0,15);

function abreviarEstado(nome) {
    const map = {'Acre':'AC','Alagoas':'AL','Amap√°':'AP','Amazonas':'AM','Bahia':'BA','Cear√°':'CE','Distrito Federal':'DF','Esp√≠rito Santo':'ES','Goi√°s':'GO','Maranh√£o':'MA','Mato Grosso':'MT','Mato Grosso do Sul':'MS','Minas Gerais':'MG','Par√°':'PA','Para√≠ba':'PB','Paran√°':'PR','Pernambuco':'PE','Piau√≠':'PI','Rio de Janeiro':'RJ','Rio Grande do Norte':'RN','Rio Grande do Sul':'RS','Rond√¥nia':'RO','Roraima':'RR','Santa Catarina':'SC','S√£o Paulo':'SP','Sergipe':'SE','Tocantins':'TO'};
    return map[nome] || (nome && nome.length === 2 ? nome.toUpperCase() : 'SC');
}

// Add shake animation
const style = document.createElement('style');
style.textContent = `@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}`;
document.head.appendChild(style);
</script>

</body>
</html>
